# Journal — Audio Implementation

Date: 2025.12.19

## Entry 1
- Started implementation phase for Scots-only audio support (WAV/MP3/MIDI), independent of graphics.
- Will add `audio` feature, create audio module, remove English audio names, and wire interpreter to register Scots API.
- Need to add MIDI pipeline (midly + rustysynth) and bundle MuseScore General SF2.

## Entry 2
- Added `audio` feature and MIDI deps to `Cargo.toml`; fetched crates (midly, rustysynth).
- Added `src/audio.rs` with Scots-only API, handle management, raylib integration, and MIDI playback via RustySynth.
- Wired interpreter to register audio functions independently of graphics; removed audio stubs from `src/graphics.rs`.

## Entry 3
- Downloaded `MuseScore_General.sf2` and license/readme into `assets/soundfonts/`.
- Added local `assets/soundfonts/README.md` with attribution pointers.

## Entry 4
- Added default soundfont path resolution (cwd/exe-relative) and updated MIDI loader to use it.
- Added README + docs/audio.md updates for Scots-only audio API.

## Entry 5
- Implementation wrapped up; audio module, docs, and assets in place.
- Tests not run yet (raylib build deps may be required).

## Entry 6
- Added test-only audio backend shims and extensive unit tests for audio API.
- Added tiny generated audio assets (wav/mp3/midi) and a new audio showcase demo.
- Removed unused midly dependency from the audio feature.

## Entry 7
- Enabled all features by default (cli, llvm, graphics, audio).

## Entry 8
- Updated README and docs/audio.md to reflect default features now include audio/graphics and how to opt out.

## Entry 9
- Added Ubuntu/WSL raylib build deps (X11 dev packages + cmake) to README and docs/audio.md.

## Entry 10
- Added a troubleshooting section for raylib build errors in README.

## Entry 11
- Added libclang/bindgen troubleshooting notes to README.

## Entry 12
- Added libclang/bindgen troubleshooting notes to docs/audio.md.

## Entry 13
- Added LLVM backend guard for audio builtins with a clear compile-time error.
- Documented that audio is interpreter-only for now in README and docs/audio.md.

## Entry 14
- Drafted HLD for audio support across all backends (interpreter, LLVM/native, JS, WASM).
- Captured runtime ABI, WebAudio strategy, native linking changes, and testing plan.

## Entry 15
- Implemented Rust runtime audio layer (raylib + rustysynth) with C ABI for LLVM/native; added audio stubs behind feature gates.
- Wired LLVM runtime bindings and codegen for all audio builtins; linked embedded raylib staticlib when audio is enabled.
- Added JS audio runtime (WebAudio + rustysynth wasm) plus WASM host helpers.
- Added rustysynth WASM helper crate and bundled mdh_rustysynth.wasm asset.
- Updated README + docs/audio.md for multi-backend audio assets and overrides.

## Entry 16
- Fixed runtime audio parity (muisic_spiel/midi_spiel resume behavior, midi_stap sequencer stop, is_spielin checks).
- Hardened JS soond_steek cleanup and exposed mdh_wasm_audio_imports globally.
- Added LLVM and WASM compiler tests covering audio builtins and imports.
- Documented WAT/WASM audio host wiring in README and docs/audio.md.

## Entry 17
- Acknowledged request to proceed with implementation and continued updates.
- Journal maintenance confirmed; future changes will be logged here.

## Entry 18
- Fixed WAT string data to include null terminators for C-string host decoding.
- Added a WASM compiler test to assert null-terminated string data emission.

## Entry 19
- Added LSP docs and completion entries for all audio builtins (soond/muisic/midi).
- Extended LSP completion test to include soond_stairt.

## Entry 20
- Reserved WASM string offset 0 for nil sentinel; strings now start at offset 1 so audio host can use ptr=0 to mean “naething”.

## Entry 21
- Fixed runtime compile errors: switched audio state to thread-local RefCell (avoids Send/Sync), cleaned unused variable, and made runtime helpers pub(crate).
- Removed unused assignment warning in dtls_handshake by returning selected SRTP profile alongside stream.

## Entry 22
- Fixed LLVM codegen runtime declarations for audio builtins and removed a redundant graphics import.
- Adjusted MIDI stream test to skip when audio feature is enabled (raylib backend).

## Entry 23
- Cleaned clippy warnings: const thread_local init in graphics, removed duplicate color patterns, replaced clamp01 with f32::clamp, and relaxed interpreter clippy lints for range/let-unit cases.
- Adjusted LLVM codegen argument checks for zero-arg audio builtins to use is_empty().

## Entry 24
- Tweaked audio helper tests to satisfy clippy bool assert comparison lint.

## Entry 25
- Dropped Linux X11/GL link flags for raylib in native compiler to keep audio-only builds from requiring X11 dev libs.
- Made soond_showcase asset paths robust by probing parent directories for bundled audio files.
