# Journal - tri 3D graphics (LLVM/native)

Date: 2025-12-20

## 09:15
- Added MDH_TAG_NATIVE to runtime header and implemented native object support in mdh_runtime.c (native get/set/call helpers, type_name handling, type_error strings).
- Implemented tri module/object/constructor stubs in C runtime: constructors, defaults, method dispatch (adde/remuiv/cloan/etc.), transform fields, constants, and tri module singleton.
- Wired LLVM codegen to native runtime: declared native_get/set/call0..8 and tri_module, updated import handling for tri, added native branches to get/set/method calls, and allowed calling native values.
- Added LLVM tests for tri constructor-as-value call and native method dispatch (children list).

## 09:40
- Aligned native ctor typing: whit_kind now reports "native function" for tri constructors, is_a("function") recognizes tri ctor values, and __mdh_is_function includes native ctor.
- Added native object string formatting in runtime (__mdh_to_string) to show <native ...> and <native dae tri.X> for constructors.

## 10:20
- Matched tri constructor defaults in the LLVM C runtime to interpreter/WAT (BoxGeometrie, cameras, lights, materials, etc.).
- Added tri default-constructor coverage tests for interpreter and LLVM runs (BoxGeometrie width = 1).

## 10:45
- Added WAT host runner support for tri constructor values (constructor handle type, string formatting, truthiness, and property get on tri module).
- Centralized tri handle calling in the WASM runner and wired all method_call arities through it.

## 11:05
- Added WASM compiler support for calling local value handles via method-call "call" (enables tri constructor value calls).
- Added WAT test for tri constructor-as-value calls and updated unsupported-call error message.

## 11:35
- Added graphics3d feature plumbing (top-level + runtime crate), build.rs propagation, and a new Rust tri runtime module scaffold in `runtime/mdh_runtime_rs`.
- Implemented Rust-side tri module/object/ctor semantics with defaults and method stubs to prepare for C runtime delegation.

## 11:55
- Wired C runtime tri paths to call Rust tri runtime when `MDH_TRI_RUST` is enabled (native get/set/call + module).
- Added Rust tri runtime implementation (module/object/ctor state + methods) and feature plumbing in build system.

## 12:20
- Added a stub tri engine layer (renderer handles + sizing/pixel ratio) and integrated it into the Rust tri runtime for Renderar methods.
- Tri objects now track optional renderer handles; render/setSize/setPixelRatio call into the engine stub.

## 12:45
- Swapped Rust tri runtime to use the thread-local tri_engine (with_engine) and removed the stale TriEngine mutex path.
- Added pollster as an optional dependency and included it in the graphics3d feature for wgpu init.

## 13:20
- Implemented winit event loop integration in tri_engine (AboutToWait redraw, RedrawRequested handling, resize/scale updates) with dt callback support.
- Added Renderar.loop callback wiring in tri_runtime (supports function/closure calls with dt seconds).
- Added minimal tri showcase example at `examples/showcases/tri_showcase/tri_showcase.braw`.

## 13:40
- Fixed build.rs feature args lifetime by switching cargo_args to owned Strings.
- Verified `cargo build --features graphics3d`, `cargo fmt`, and `cargo clippy --all-targets --features graphics3d` succeed locally.

## 14:20
- Added basic mesh rendering pipeline (WGSL shader, uniforms, depth buffer) and render_scene API in tri_engine.
- Implemented scene traversal + geometry generation (box/sphere), camera view-projection, and material color parsing in tri_runtime.
- Wired Renderar.render to build render items and call render_scene; added Renderar opts parsing (width/height/pixelRatio).
- Updated graphics3d feature deps with bytemuck and validated runtime crate builds.

## 14:35
- Ran `cargo build --features graphics3d` and `cargo clippy --all-targets --features graphics3d` clean after mesh rendering additions.

## 14:55
- Added GPU mesh cache in tri_engine to avoid re-uploading geometry every frame (cached by native geometry handle).

## 15:20
- Added normals + lighting support (ambient + directional) to the tri renderer and WGSL pipeline.
- Implemented light traversal and material lighting modes in tri_runtime; box/sphere geometry now generate normals.

## 15:35
- Ran `cargo build --features graphics3d` and `cargo clippy --all-targets --features graphics3d` after lighting changes.

## 16:05
- Added point light support (PyntLicht) with distance/decay attenuation in shader uniforms.
- Extended render items and WGSL to shade with ambient + directional + point lights.

## 16:15
- Ran `cargo build --features graphics3d` and `cargo clippy --all-targets --features graphics3d` after point light support.

## 16:35
- Added per-object uniform buffer caching keyed by mesh instance handle to reduce per-frame allocations.

## 16:45
- Ran `cargo build --features graphics3d` and `cargo clippy --all-targets --features graphics3d` after uniform caching.

## 16:55
- Expanded tri_showcase to include ambient, directional, and point lights.

## 17:15
- Implemented tri.dyspos cleanup: removes objects from Rust tri state and clears renderer/mesh/uniform caches in tri_engine.

## 17:25
- Ran `cargo build --features graphics3d` and `cargo clippy --all-targets --features graphics3d` after dispose cleanup.

## 17:55
- Added material params (metalness/roughness) parsing and passed them into shader uniforms for simple shading adjustments.

## 18:05
- Ran `cargo build --features graphics3d` and `cargo clippy --all-targets --features graphics3d` after material param updates.

## 18:10
- Updated tri_showcase material to include roughness/metalness params.

## 18:35
- Added Renderar.tick/poll method (aliases render using stored scene/camera).
- Expanded tri_showcase with a manual loop variant and a renderar.loop variant showcasing camera orbit.

## 18:45
- Ran `cargo build --features graphics3d` and `cargo clippy --all-targets --features graphics3d` after showcase + tick updates.

## 19:05
- Added wireframe render option via Renderar opts (wireframe bool) and pipeline selection when supported.
- Updated tri_showcase examples to include wireframe option.

## 19:15
- Ran `cargo build --features graphics3d` and `cargo clippy --all-targets --features graphics3d` after wireframe option.

## 19:40
- Added interactive camera controls showcase using get_key (tri_showcase_controls.braw).

## 19:45
- Ran `cargo build --features graphics3d` and `cargo clippy --all-targets --features graphics3d` after controls showcase.

## 20:10
- Added FPS counters and point-light orbit to all tri showcase variants.
- Added runtime wireframe toggle on 'f' key in controls showcase.

## 20:15
- Ran `cargo build --features graphics3d` and `cargo clippy --all-targets --features graphics3d` after showcase updates.

## 20:30
- Fixed tri showcase trig calls to use built-in sin/cos (replaced sine/cosine).

## 20:35
- Verified mdhavers builds for tri_showcase, tri_showcase_loop, tri_showcase_controls after trig fix.

## 20:45
- Added graphics3d to default feature set and updated README default-features note.

## 21:20
- Added hurl-based error reporting for Renderar init/render/loop failures.
- Ran `cargo fmt`.
- `cargo build --features graphics3d` failed in this env due to ep-miniaudio-sys bindgen invalid ident (audio feature).
- `cargo build --no-default-features --features cli,llvm,graphics3d` and matching `cargo clippy --all-targets --no-default-features --features cli,llvm,graphics3d` completed cleanly.

## 22:10
- Added support for `MDH_TRI_BACKEND` / `WINIT_UNIX_BACKEND` env vars to force winit backend (x11/wayland) before EventLoop creation.
- Ran `cargo fmt`.
- Started `cargo build --no-default-features --features cli,llvm,graphics3d` to validate, but cancelled due to long compile time in this session.
