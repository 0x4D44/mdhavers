# Journal: Raw Terminal Input Implementation

**Date:** 2025.12.09
**Author:** Gemini Agent

## 1. Code Review & Analysis

I reviewed the changes made to support `get_key()` in the LLVM backend.

### Findings:

1.  **Architecture Shift:** The initial assumption that `CodeGen` fully inlines everything was partially incorrect or at least insufficient for OS-level interactions like `termios`. The implementation correctly shifted to a "Hybrid" model where we link against `mdh_runtime.o`.
    *   *Status:* Implementation in `src/llvm/codegen.rs` calls `__mdh_get_key` correctly.

2.  **Critical Linker Error:** The `src/llvm/compiler.rs` was updated to link `mdh_runtime.o` and `-lm`. However, the C runtime uses Boehm GC (`GC_malloc`, `GC_strdup`).
    *   *Issue:* The linker command is missing `-lgc`. This will cause linking to fail with undefined references to `GC_malloc` etc.
    *   *Fix:* Must add `"-lgc"` to the `Command::new("cc")` arguments.

3.  **Runtime Path Hardcoding:** `src/llvm/compiler.rs` hardcodes `"runtime/mdh_runtime.o"`.
    *   *Issue:* This breaks if the compiler is run from outside the project root.
    *   *Fix:* For now, in this dev environment, it's acceptable, but should be noted in the design doc. Ideally, it should look relative to the binary or in a standard install location.

4.  **Header Sync:** `runtime/mdh_runtime.h` was updated, and `runtime/mdh_runtime.c` implements the logic. The logic uses `read` and `termios`.
    *   *Review:* The escape sequence parsing is minimal (only handling `[A`, `[B` etc.). This is a known MVP limitation compared to the interpreter's `crossterm` support.

## 2. Action Plan

1.  **Update Design Doc:** Document the hybrid linking approach and dependencies (`libgc`).
2.  **Fix Compiler:** Modify `src/llvm/compiler.rs` to include `-lgc` in linker args.
3.  **Verify:** Attempt to compile a test program. If `libgc` is missing in the current environment, acknowledge the limitation but ensure the code is correct.

## 3. Implementation Log

*   **[2025.12.09]** Initial implementation of `get_key` in C runtime and LLVM codegen.
*   **[2025.12.09]** Identified missing `-lgc` linker flag.
*   **[2025.12.09]** Updating design documentation to reflect architecture changes.
