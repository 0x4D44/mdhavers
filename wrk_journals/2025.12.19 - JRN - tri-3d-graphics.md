# Journal - tri 3D graphics planning

Date: 2025-12-19

## 09:20
- Captured requirements: strict Scots API, English properties allowed, module strategy A (fetch "tri"), three.js semantics, wgpu backend, all targets including WAT, full native linkage.
- Planned spec sections: naming glossary, API surface, native hooks, target plans, WAT host runner.

## 10:05
- Drafted and saved the tri 3D spec to wrk_docs/2025.12.19 - tri-3d-graphics-spec.md.
- Included phased roadmap, target-specific architecture, and NativeObject hook requirements.
- Noted WAT constraints and host-runner requirement for single-binary support.

## 10:15
- Ready for review; awaiting feedback on naming glossary and WAT runner expectations before implementation.

## 11:05
- Started detailed design for NativeObject and WAT host runner per request.
- Gathered current WAT compiler shape: minimal i64-only values; no dict/object support.

## 11:35
- Drafted NativeObject trait and interpreter integration plan (get/set/call routing).
- Sketched LLVM runtime tag and accessors for native objects.

## 12:05
- Designed WAT host runner strategy: wasmtime host with wgpu + handle-based value model.
- WAT compiler changes scoped to host-handle ops and tri module special-case.

## 12:15
- Saved design doc: wrk_docs/2025.12.19 - nativeobject-and-wat-runner-design.md.

## 13:05
- Began implementation: added NativeObject trait and Value::NativeObject variant in src/value.rs.
- Added ValueKey::NativeObject and display/type_name handling.
- Implemented interpreter routing for native get/set/call in Expr::Get/Set/Call.
- Added call_value error for attempting to call a native object directly.
- Added tests for native object type_name.

## 13:25
- Added whit_kind native-object awareness to surface concrete type names.

## 14:05
- Added initial WAT host runner implementation in src/wasm_runner.rs (wasmtime + wat).
- Added optional Cargo feature `wasm_runner` with dependencies wasmtime/wat.
- Added CLI subcommand `wasm-run` (feature-gated) to execute .wat/.wasm via host runner.

## 16:10
- Refactored WASM compiler to host-handle value model and added property/get/set, list, dict, and method-call support.
- Updated WAT imports to __mdh_* runtime calls and adjusted control-flow truthiness handling.
- Added temp locals for logical ops and list/dict construction; ensured string offsets align with data section.
- Updated WASM compiler tests for new import names and semantics.

## 16:45
- Rewrote wasm_runner with a host value store and __mdh_* imports (constructors, ops, truthy, blether, list/dict, prop get/set).
- Added audio import stubs to satisfy always-present WASM imports.
- Left method-call hooks as stubs (return nil) pending native tri registry.

## 17:20
- Finished host runner refactor: added HostStore helpers, binop/cmp helper registration, and audio stub helpers to avoid linker borrow issues.
- Updated WAT compiler string data offsets and ensured temp locals for logical/list/dict builds.

## 17:55
- Added interpreter tests for NativeObject get/set/call behavior with a TestNative implementation.

## 18:05
- Added WAT support for `fetch "tri" tae tri` (import alias handling) and host import `__mdh_tri_module` stub.
- Added WAT compiler tests for tri import alias requirement.

## 19:05
- Added interpreter-side tri module stub (src/tri.rs) with NativeObject constructors, constants, and transform defaults.
- Integrated tri module loader in interpreter (alias required) and added tri module to lib/main modules.
- Expanded wasm runner with tri native object stubs, transform defaults, and tri module method-call handling.
- Updated WASM compiler tests to assert against new __mdh_* runtime calls.

## 19:45
- Implemented tri module stub for interpreter (NativeObject-based) and enforced alias import.
- Added JS compiler tri adapter (__havers_tri) and special-case import handling; added compiler test.
- Extended wasm runner tri constructor handling and native object property storage.
- Updated wasm compiler arithmetic/comparison tests to match runtime-call output.

## 20:10
- Populated wasm tri module with DEG_TO_RAD/RAD_TO_DEG constants and ensured tri module set tracking.

## 20:25
- Added interpreter tests for tri import alias requirement and tri constructor type reporting.

## 21:40
- Aligned tri stubs with English property names (geometry/material, color, widthSegments/heightSegments) and made Sicht include transforms.
- Added tri constructor argument mapping and type field on native tri objects in interpreter stubs; clone now copies fields.
- Updated WASM host runner tri objects to include type field, accept constructor args, and treat Sicht as transform-bearing.

## 22:10
- Added Scots method aliases and renderer loop handling in JS tri adapter; constructors now wrap objects to attach methods.
- Expanded interpreter tri NativeObject to track children/parent and handle adde/remuiv/set_sise/set_pixel_ratio/render/luik_at.
- Added tri object method handling in WAT runner (adde/remuiv/cloan/etc.) and default children storage.
- Extended stdlib tri stub with common methods, renderer helpers, and clone utility.
- Updated agents guide with tri and wasm runner entry points.

## 22:35
- Enforced tri alias requirement in JS compiler to match interpreter/WAT behavior.
- Added LLVM import alias support by building dict modules from exported names.
- LLVM now rejects tri imports without alias and supports `fetch "tri" tae tri`.
- WAT runner parent updates removed to avoid implying parent ownership in native stubs.
- JS compiler now treats `tri.braw` like `tri` for import handling.

## 22:55
- Extended WASM method-call imports/dispatch to support up to 8 args (to cover OrthograffikKamera and similar).

## 23:15
- Allowed variadic native functions in interpreter (arity == usize::MAX).
- Tri module now returns callable constructor functions from property access (tri.Sicht), alongside method-call support.

## 23:25
- Added WASM compiler test for 6-arg tri constructor to ensure method_call6 emission.

## 23:35
- LLVM alias module dicts now include functions/vars only (skips classes) to avoid invalid class-as-value construction.

## 23:45
- LLVM alias imports now hide newly imported names from the top-level scope, matching interpreter alias semantics.

## 23:55
- Added interpreter test for calling tri constructor via property access (tri.Sicht).

## 00:20
- LLVM codegen: method-call handling now detects dict-backed callee (e.g., module alias) and calls retrieved function values directly.
- Added LLVM test for dict function call via property syntax.

## 00:45
- LLVM codegen: track import alias exports and route alias method calls through the standard user-function call path (defaults + spread), avoiding bad arity when calling module constructors like tri.PerspectivKamera.
- Refactored user-function call logic into compile_user_function_call and reused for alias dispatch.

## 01:10
- LLVM import alias now hides all imported names (including tri internal _tri_*), while alias dict exposes only public names.
- tri renderer loop now stores callback as loopFn across interpreter, WAT host runner, and stdlib stub (no-op alignment).

## 01:20
- Aligned lookAt storage across native stubs: interpreter/WAT now store lookAtTarget (avoids clobbering lookAt method).

## 01:35
- Added stdlib search paths to import resolution (LLVM + interpreter) so fetch "tri" and other stdlib modules resolve without manual file placement.

## 01:50
- LLVM alias dispatch now verifies the alias binding pointer and drops alias metadata on reassignment to avoid incorrect module call routing after shadowing or reassignment.

## 02:05
- Added LLVM import coverage test ensuring alias shadowing drops module dispatch (mod reassigned to dict; method call uses dict function).

## 02:20
- Import resolution now treats lib/* paths as stdlib/* fallbacks (interpreter + LLVM), aligning with docs while preserving local overrides.

## 02:35
- LLVM import resolution now preserves examples/lib fallback for string-compiled sources (no source path) before stdlib lib/ mapping, avoiding test regressions.

## 02:50
- Added LLVM coverage test for tri module import + constructor (tri.Sicht) to ensure alias dispatch path works for stdlib tri.
