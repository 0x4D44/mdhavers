# Journal: SIP/RTP runtime implementation

Date: 2025.12.19

## Session 1

- Started implementation work. Created this journal.
- Next: add MDH_TAG_BYTES scaffolding + runtime/LLVM/interpreter stubs; then implement bytes + monotonic time.

## Session 2

- Added MDH_TAG_BYTES to runtime header and LLVM types.
- Added Bytes variant to interpreter Value and updated display/truthy/equality.
- Declared bytes/mono runtime functions in LLVM runtime declarations.
- Added MDH_TAG_BYTES constant and JSON fallback handling in Rust runtime shim.
- Next: implement bytes + monotonic time in C runtime, then wire LLVM codegen + interpreter builtins.

## Session 3

- Implemented bytes + monotonic time in `runtime/mdh_runtime.c` (new bytes API, mono_ms/mono_ns) and updated type handling (truthy, len, type_name, clype, eq).
- Wired LLVM codegen: added bytes/mono runtime declarations, updated `inline_len` and `is_truthy`, and added new builtin dispatch for bytes/mono.
- Added interpreter bytes support and builtins, plus mono_ms/mono_ns, and updated `is_a` and `len`.
- Fixed borrow issues in interpreter bytes write functions; `cargo check` now passes.

## Session 4

- Added stdlib module `stdlib/bytes.braw` with convenience wrappers.
- Added interpreter test `tests/interpreter_bytes.rs` and confirmed it passes.
- Updated `stdlib/README.md` to list the new bytes module.

## Session 5

- Added socket option APIs (reuseaddr/reuseport/ttl/nodelay/rcvbuf/sndbuf) in C runtime + header; added setsockopt implementations and extra network includes.
- Expanded interpreter socket support: fixed IPv4 byte order, added socket option builtins, and updated DNS lookup to return A/AAAA.
- Wired LLVM backend for network builtins: new runtime declarations, LibcFunctions fields, and builtin match arms for socket/UDP/TCP/DNS.
- Added stdlib `network_real.braw` wrappers and listed `network`/`network_real` in `stdlib/README.md`.
- Added `tests/interpreter_network.rs` for DNS + UDP/TCP loopback; updated native builtin coverage test to skip network builtins to avoid blocking.

Next: finish Stage 2 by validating full test suite and, if needed, add any missing runtime options (or proceed to Stage 3: event loop + timers).

## Session 6

- Implemented event loop + timers in C runtime using poll(): loop registry, watch management, timer scheduling, and `event_loop_poll` with event dicts.
- Added interpreter event loop registry (thread-local), watch/timer structs, and new builtins: event_loop_new/stop/poll, watch_read/write, unwatch, timer_after/every/cancel.
- Added LLVM declarations + builtin dispatch for event loop/timer functions.
- Added stdlib `event_loop.braw` wrappers with `event_loop_run` dispatcher; updated stdlib README.
- Added interpreter tests for event loop timer + read readiness; confirmed `interpreter_network` and `interpreter_event_loop` tests pass.

Next: update plan/notes for the event-loop API (event_loop_poll + stdlib dispatch) and proceed to Stage 4 (threads + sync + channels).

## Session 7

- Added threading/synchronization/channel APIs to C runtime (pthread-based) with GC thread registration stubs; implemented thread spawn/join/detach, mutex/condvar, atomics, and channels.
- Added GC thread registration no-op stubs in `runtime/gc_stub.c` and linked pthreads in LLVM compiler.
- Implemented interpreter concurrency builtins with safe single-threaded semantics (native-only thread_spawn, mutex/condvar/atomic/channel registries).
- Added LLVM declarations + builtin dispatch for concurrency APIs.
- Added stdlib `concurrency.braw` wrappers and updated stdlib README.
- Added tests: `interpreter_concurrency` (atomic/channel) and `llvm_runtime_threads` (thread+atomic); verified interpreter network/event_loop tests still pass.

Next: move to Stage 5 (DNS SRV/NAPTR + SIP helpers).

## Session 8

- Added DNS SRV/NAPTR runtime plumbing: new C runtime wrappers (`__mdh_dns_srv`, `__mdh_dns_naptr`) calling Rust FFI, plus header prototypes and Rust resolver fixes for NAPTR byte fields.
- Extended interpreter builtins with trust-dns-resolver (dns_srv/dns_naptr) and aligned dns_lookup errors with result dicts; added resolver helper.
- Wired LLVM backend for DNS SRV/NAPTR (LibcFunctions fields, runtime declarations, builtin dispatch).
- Added stdlib `stdlib/sip.braw` with SIP transport defaults, NAPTR/SRV/A-AAAA resolution (`sip_resolve`), and SIP message parse/build helpers.
- Updated stdlib README to include SIP module; added tests `tests/interpreter_dns_srv_naptr.rs` and `tests/stdlib_sip.rs` (using stdlib/sip).
- Test run: `cargo test --test interpreter_dns_srv_naptr` and `cargo test --test stdlib_sip` (after fixing NAPTR byte decoding and module path) passed.

Next: consider adding LLVM-side tests for dns_srv/dns_naptr or sip_resolve, and update docs if needed.

## Session 9

- Added TLS runtime surface (C wrappers + Rust FFI) and interpreter builtins using rustls, with config parsing for client/server, CA roots, and optional insecure mode.
- Added TLS stdlib wrappers (`stdlib/tls.braw`) and SRTP stubs (`stdlib/srtp.braw`), plus README updates.
- Implemented DTLS/SRTP stubs in the runtime/interpreter (returning explicit not-implemented errors).
- Added TLS integration tests (`tests/interpreter_tls.rs`) that exercise mdhavers TLS client against a Rust server and mdhavers TLS server against a Rust client using self-signed certs.
- New dependencies: rustls, rustls-pemfile, webpki-roots; dev dependency rcgen.

Next: decide whether to implement full DTLS/SRTP (currently stubbed) and optionally add LLVM-side TLS tests.

## Session 10

- Implemented DTLS + SRTP in the interpreter using udp-dtls + libsrtp: registries, config parsing, key extraction, and protect/unprotect operations.
- Added DTLS/SRTP helpers (profile mapping, key/salt lengths, PEM identity) in both interpreter and Rust runtime; fixed DTLS error formatting and cleaned unused imports.
- Updated stdlib `srtp.braw` with `srtp_from_dtls` convenience wrapper.
- Added interpreter tests `interpreter_dtls` and `interpreter_srtp`; both pass.
- Updated Cargo.lock via test runs.

Next: run full test suite if needed, then consider Stage 7 (optional SIP/RTP reference stack) or documentation updates.

## Session 11

- Implemented stdlib RTP/RTCP helpers (`stdlib/rtp.braw`, `stdlib/rtcp.braw`) with build/parse support.
- Added bytes-to-string helpers in `stdlib/bytes.braw` and `stdlib/sip.braw` for SIP parsing from UDP bytes.
- Added SIP/RTP demo (`examples/showcases/sip_rtp_echo.braw`).
- Updated stdlib README with RTP/RTCP modules and builtins reference doc with networking/concurrency/TLS/DTLS/SRTP/bytes additions.
- Added tests `tests/stdlib_rtp.rs` and `tests/stdlib_rtcp.rs`; stdlib SIP test still passes.

Next: check for any remaining plan items, then run broader tests if desired.
- Added basic SIP transaction/retransmit helpers in `stdlib/sip.braw` (UDP backoff schedule + state dict updates).
- Re-ran stdlib SIP test after sip.braw changes; it still passes.
- Updated stdlib reference doc to cover `stdlib/` modules and keep examples/lib section.
- Extended stdlib SIP test to cover bytes input; test passes.
