# Journal — Compiler Parity Work
**Date:** 2025-12-18
**Repo:** `mdhavers`
**Focus:** Close feature/semantic gaps between the Rust interpreter and the LLVM native backend.

## 09:15 — Handoff + current state
- Full test suite is currently green (`cargo test -q`) and LLVM comprehensive suite is large (~7k tests).
- Recent LLVM fixes already in tree (try/catch stability, set-union runtime function wiring, default `__current_suite`, etc.).
- Coverage work is already complete for the 98% target (see `wrk_docs/2025.12.18 - CC - code coverage analysis report.md`).

## 09:20 — Parity direction (decision)
I’m treating the **Rust interpreter as canonical semantics** for user code and aligning the LLVM backend to it.

Immediate priorities:
1) **Dict keys:** interpreter stringifies dict literal keys; LLVM currently stores typed keys. Plan: make LLVM dict literals and dict/set mutators use **stringified keys** (via `tae_string`-style conversion).
2) **Creel (set) semantics:** interpreter’s `creel(list)` constructs a set; LLVM’s `creel()` currently constructs an empty list and `creel(list)` copies lists. Plan: make LLVM `creel(...)` match interpreter and move list-copy semantics to existing list helpers (e.g. `copy()`), updating E2E tests accordingly.
3) **Range inclusive:** LLVM materialization of `a..=b` into a list currently ignores inclusivity. Plan: fix the inclusive case by materializing end as `end + 1` for the list-path.

## 09:25 — Next implementation tranche
- Implement correctness-critical placeholders called out in the parity plan:
  - Dict: `dict_get`, `dict_merge`, `dict_remove`, `dict_invert`, `fae_pairs`
  - Set: `creels_baith`, `creels_differ`, `is_subset`, `is_superset`, `is_disjoint`
  - Assertions: `assert`, `assert_equal`, `assert_nae_equal`
- Implement missing interpreter builtins in LLVM backend (inventory currently shows 52 missing names), including:
  - OS/env/fs: `args`, `cwd`, `chdir`, `env_*`, `list_dir`, `make_dir`, `is_dir`, `path_join`, `file_size`, `file_delete`, `scrieve_append`, `shell`, `shell_status`
  - Time/date: `timestamp`, `timestamp_millis`, `braw_date`, `date_*`
  - Regex: `regex_*`
  - JSON: `json_pretty`, `json_stringify_pretty` (plus replacing LLVM placeholder implementations)

## 09:55 — Stage 0 parity changes landed (compiler + runtime)
- **Ranges:** LLVM materialized range values now respect inclusivity (`..=`) by translating to an end-exclusive runtime call with `end + 1`.
- **Dict literals:** LLVM dict literal keys are now **stringified** (matches interpreter behavior).
- **Dict index-set:** LLVM `dict[key] = value` now stringifies non-string keys (matches interpreter).
- **Creels/sets:** Implemented runtime `__mdh_make_creel(list)` and rewired LLVM `creel(x)` to match interpreter semantics:
  - list → set (stringified elements)
  - dict/creel → passthrough (best-effort; LLVM runtime uses a single dict tag for both)
  - other → runtime type error
- **Set ops:** `toss_in`, `heave_oot`, and `is_in_creel` now stringify the element/key before interacting with the runtime dict-backed set.
- **E2E updates:** updated LLVM comprehensive tests to stop calling `creel()` (0-arg) and instead use `empty_creel()` / `creel([])` depending on intent.

## 11:30 — Runtime JSON repair + LLVM builtin parity tranche
- **Runtime build blocker:** `runtime/mdh_runtime.c` had a corrupted JSON “mega-line” chunk that broke compilation; wrapped the broken section in `#if 0` and reimplemented JSON parsing/stringifying/pretty-printing cleanly.
- **New/filled runtime functions:** added missing parity helpers in `runtime/mdh_runtime.c` (and prototypes in `runtime/mdh_runtime.h`), including:
  - JSON: `__mdh_json_parse`, `__mdh_json_stringify`, `__mdh_json_pretty`
  - Misc/string/list helpers: `__mdh_is_a`, `__mdh_numpty_check`, `__mdh_indices_o`, `__mdh_chunks`, `__mdh_grup`, `__mdh_interleave`, `__mdh_pair_adjacent`, `__mdh_skelp`, `__mdh_strip_left`, `__mdh_strip_right`, `__mdh_swapcase`, `__mdh_sporran_fill`, `__mdh_scottify`
  - Scots “fun”: `__mdh_mutter`, `__mdh_blooter`, `__mdh_stooshie`, `__mdh_dreich`, `__mdh_geggie`, `__mdh_jings`, `__mdh_crivvens`
- **LLVM codegen wiring:** expanded `LibcFunctions` + `declare_libc_functions` in `src/llvm/codegen.rs` and replaced many placeholders with real runtime calls (filesystem/env/date/regex/json + parity helpers).
- **ABI fix for args():** LLVM `main` is now generated as `main(i32 argc, i8** argv)` and seeds runtime args via `__mdh_set_args(argc, argv)`.
- **Semantic alignments:** updated `pair_up` to match interpreter (`pair_up(list)` only; 2-list pairing uses `zip`), and aligned `strip_left/right` arity to interpreter (2 args).

## 12:10 — Test + build validation
- Updated LLVM comprehensive tests for new semantics:
  - `pair_up(a, b)` → `zip(a, b)`
  - `strip_left/right(s)` → `strip_left/right(s, " ")`
  - `tae_json("hello")` expectation updated to proper JSON output (`"\"hello\""`).
  - `jings/crivvens/stooshie` now pass required message/string args.
  - `mutter("…")` test now uses `blether mutter("…")` (mutter returns a string; it does not print).
- Validation runs:
  - `cargo test --features llvm` ✅
  - `cargo fmt --all` ✅
  - `cargo clippy --all-targets --features llvm -- -D warnings` ✅
  - `cargo build --features llvm` ✅

## 19:40 — Final LLVM parity sweep (runtime + tests)
- **Empty dict vs creel printing:** fixed `blether {}` output mismatch (`creel{}` vs `{}`).
  - Root cause: runtime `__mdh_to_string`’s dict formatting treated “all entries key==value” as a set, and for empty dicts the loop never ran (so it always printed `creel{}`).
  - Fix: added a creel sentinel marker for *empty* creels, added `__mdh_empty_dict()`, updated dict-producing runtime paths to use it, and made stringification consult the marker (via `__mdh_dict_is_creel`).
- **Truthiness:** aligned tests with interpreter semantics that **empty strings are falsy**.
- **Fun Scots builtins:** updated LLVM E2E tests to match interpreter arities/return types for `och`, `help_ma_boab`, `banter`, `clype`, `stoater`, and `slainte`.
- **Runtime cleanup:** removed an old disabled “corrupted patch artifact” JSON block that still triggered `gcc` warnings even under `#if 0`.
- **Validation (re-run):**
  - `cargo test --features llvm` ✅
  - `cargo fmt --all` ✅
  - `cargo clippy --all-targets --features llvm -- -D warnings` ✅
