# 2025.12.23 - CR - Remediation Summary (mdhavers)

## Metadata
- Repo: `mdhavers` (`/home/md/language/mdhavers`)
- Date: 2025-12-23
- Git HEAD (uncommitted working tree): `746e15dd240cb90576e82ad103032c837f7f3594`
- Source report: `wrk_docs/2025.12.23 - CR - Code Review Report.md`

This document summarizes the concrete remediation work performed after the review report, with pointers to the primary files touched and verification commands that were run.

## Remediations completed

### 1) Interpreter state restoration is error-safe (RAII)
- Added `Drop` guards to ensure interpreter state (env/current_dir/stack frames) is restored even when evaluation errors out.
- Files: `src/interpreter.rs`

### 2) Numeric semantics hardened (avoid panics / UB-like behavior)
- Replaced direct integer arithmetic with `checked_*` operations and surfaced overflow as `HaversError::IntegerOverflow`.
- Fixed mixed numeric comparisons to avoid `i64 -> f64` precision loss when both sides are integers.
- Guarded string repeat against negative/oversized counts.
- Prevented `median()` from panicking on `NaN`.
- Files: `src/interpreter.rs`

### 3) Module system correctness (imports/caching/circular detection)
- Replaced “already loaded → skip” behavior with:
  - module export cache (re-inject exports on each import)
  - circular import detection with explicit `HaversError::CircularImport` path chain
- Files: `src/interpreter.rs`

### 4) WASM portability / playground builds unblocked
- Introduced a `native` feature and gated host/network/crypto dependencies and Unix-only code.
- Added wasm32 stubs for env/current_dir-dependent paths and a timer-only event loop implementation when `native` is disabled.
- Files: `Cargo.toml`, `src/interpreter.rs`

### 5) Build portability improvements (LLVM runtime embedding)
- `build.rs` emits runtime artifacts into `OUT_DIR` (and nests `mdh_runtime_rs`’s cargo build into an `OUT_DIR`-scoped `--target-dir`) so builds don’t write artifacts into `runtime/`.
- Runtime artifacts are embedded via `include_bytes!` for later native linking.
- LLVM builds are gated behind the `llvm` feature and reject unsupported targets (e.g. `wasm32`).
- Files: `build.rs`, `src/llvm/compiler.rs`

### 6) Tooling divergence reduced
- LSP diagnostics now use the real mdhavers lexer/parser instead of a separate mini-parser.
- VSCode extension now selects the first existing LSP binary path (repo `target/{release,debug}` first; PATH fallback).
- Files: `src/lsp/mdhavers_bindings.rs`, `editor/vscode/src/extension.ts`, `editor/vscode/out/extension.js`

### 7) Test/feature fragility fixed
- CLI coverage tests now assert correctly when `llvm` is disabled.
- Network/TLS/DTLS/SRTP integration tests are feature/OS gated to avoid non-native/wasm builds failing.
- Files: `tests/cli_coverage.rs`, `tests/interpreter_*.rs`, `tests/stdlib_sip.rs`

### 8) Backend parity harness added (interpreter vs JS)
- Added a small “smoke” parity test that runs the same `.braw` snippets through the interpreter and JS compiler (via `node`) and compares stdout.
- Fixed JS compiler runtime emission so `tri` (and `require('three')`) is only emitted when `tri` is imported.
- Files: `tests/backend_parity.rs`, `src/compiler.rs`

### 9) Lexer performance + position tracking fixed
- Replaced O(n²)-ish “rescan from last newline” logic with a single forward cursor that updates `(line, column)` incrementally across token spans (handles multiline tokens and Unicode columns consistently).
- Added regression tests for multiline-string line/column tracking and Unicode column counting.
- Files: `src/lexer.rs`

### 10) WASM backend import surface minimized
- WAT generator now emits optional imports only when they’re actually used:
  - `__mdh_tri_module` only when `fetch "tri"` appears.
  - audio imports only for referenced audio builtins (e.g. `soond_stairt`).
- Added tests to assert unused imports are not emitted and tightened existing audio/tri import assertions.
- Files: `src/wasm_compiler.rs`

### 11) Test harnesses made more robust to build paths
- CLI/LSP integration tests now prefer Cargo-provided binary paths (`CARGO_BIN_EXE_mdhavers`, `CARGO_BIN_EXE_mdhavers-lsp`) with existing llvm-cov overrides preserved.
- Files: `tests/cli_coverage.rs`, `tests/lsp_coverage.rs`

### 12) Clippy is clean under `-D warnings` (minimal + LLVM)
- Minimal build (`--no-default-features --features cli`) is now warning-clean by cfg-gating native-only helpers and unix-only event watch fields.
- LLVM build remains warning-clean:
  - removed clippy-triggering `return` patterns across `cfg` blocks.
  - fixed a `let`-and-return pattern in `call_function`.
  - gated `MDH_TAG_NATIVE` to the feature that uses it inside `runtime/mdh_runtime_rs`.
- Files: `src/interpreter.rs`, `runtime/mdh_runtime_rs/src/lib.rs`

### 13) LLVM comprehensive test suite made opt-in
- The very large `tests/llvm_comprehensive_tests.rs` suite is now gated behind a dedicated Cargo feature so it doesn’t run in normal LLVM test runs.
- To run it explicitly:
  - `cargo test --test llvm_comprehensive_tests --no-default-features --features cli,llvm,native,llvm_comprehensive_tests`

### 14) CLI binary no longer re-compiles the library
- `src/main.rs` now imports `mdhavers::...` instead of declaring `mod ...` for most library modules, so code is compiled once (as the library crate) rather than twice (lib + bin).
- Files: `src/main.rs`

### 15) wasm runner feature fixed + shared via the library
- Exported `wasm_runner` from the library and updated it for current `wasmtime` APIs (Linker `define` signature and `func_wrap` return type), plus minor clippy cleanups.
- Files: `src/wasm_runner.rs`, `src/lib.rs`

### 16) Installer messaging made accurate
- Installer docs now avoid implying a “remote install from releases” works when it’s not implemented.
- Files: `installer/install.sh`, `installer/README.md`

### 17) tri/native-object errors report the correct line
- Native object `get`/`set`/`call` errors that previously reported `line: 0` are now upgraded to the call-site span line in the interpreter (without changing the `NativeObject` trait).
- This improves diagnostics for `tri` and any other native objects that used `line: 0` as “unknown”.
- Files: `src/error.rs`, `src/interpreter.rs`

### 18) REPL supports multiline input
- REPL now accumulates input across lines until braces/brackets/parens and string quotes are balanced, enabling multiline `dae`/`gin`/`whiles` blocks and multiline strings.
- Added `:cancel` to abandon an unfinished multiline entry; while in multiline mode, only `:`-prefixed commands are recognized (so plain text like `help` can appear inside multiline strings).
- Files: `src/main.rs`

### 19) Stdlib contract clarified (stability/portability/sandboxing)
- Added explicit guidance for which stdlib modules are expected to be portable vs native-only, plus stability and sandboxing notes.
- Files: `stdlib/README.md`

### 20) Audio asset provenance documented (SoundFont + WASM helper)
- Added download instructions for the default SoundFont and pointers to the WASM helper rebuild docs, so JS/WASM audio setups are reproducible.
- Files: `assets/soundfonts/README.md`, `README.md`, `docs/audio.md`

### 21) Repo hygiene: ignore common generated artifacts
- Ignored packaging output (`dist/`), wasm-pack output (`playground/pkg/`), large binary assets, and example build outputs.
- Files: `.gitignore`

### 22) Vendored dependency provenance documented
- Added notes on why `raylib-sys` is vendored (Cargo patch) and how to update it.
- Files: `vendor/README.md`

### 23) Vendored `raylib-sys` tree reconciled
- Staged previously-untracked upstream files inside the vendored `raylib-sys` directory so working copies don’t accumulate “mystery” untracked vendor files.
- Files: `vendor/raylib-sys-5.5.1/`

### 24) VSCode extension workflow documented
- Added build and LSP wiring notes for the VSCode extension (including how it locates `mdhavers-lsp`).
- Files: `editor/vscode/README.md`

### 25) README CLI docs corrected (WAT/WASM)
- Updated examples to use the real CLI surface (`mdhavers wasm ...`) instead of the older `compile --target wat` form.
- Files: `README.md`

### 26) Stdlib + examples sources reconciled with docs
- Added the missing `.braw` sources referenced by `README.md`/`stdlib/README.md` (so docs match the on-disk modules/examples).
- Files: `stdlib/bytes.braw`, `stdlib/concurrency.braw`, `stdlib/event_loop.braw`, `stdlib/network_real.braw`, `stdlib/sip.braw`, `stdlib/rtp.braw`, `stdlib/rtcp.braw`, `stdlib/tls.braw`, `stdlib/srtp.braw`, `stdlib/tri.braw`, `examples/basics/*.braw`, `examples/features/*.braw`, `examples/showcases/*.braw`, `examples/showcases/tri_showcase/*.braw`, `examples/hello.braw`, `examples/fizzbuzz.braw`, `examples/functions.braw`, `examples/stdlib/collections_demo.braw`

### 27) Stray duplicate doc artifact removed
- Removed an extensionless duplicate of an existing `wrk_docs` markdown file.
- Files: `wrk_docs/2025.12.19`

## Verification run
These were executed successfully after the remediation work:
- `cargo test --tests --no-default-features --features cli`
- `cargo test --lib --no-default-features --features cli`
- `cargo test --test backend_parity --no-default-features --features cli`
- `cargo test --test cli_coverage --no-default-features --features cli`
- `cargo test --test lsp_coverage --no-default-features --features cli`
- `cargo test --tests` (defaults)
- `cargo test --lib --no-default-features --features cli,llvm,native`
- `cargo test --tests --no-default-features --features cli,llvm,native` (now completes without running `llvm_comprehensive_tests` by default)
- `cargo test --test cli_coverage --no-default-features --features cli,llvm,native`
- `cargo test --test llvm_standalone_tests --no-default-features --features cli,llvm,native`
- `cargo test --test llvm_compile_repo_modules_coverage --no-default-features --features cli,llvm,native`
- `cargo clippy --no-default-features --features cli -- -D warnings`
- `cargo clippy --features cli -- -D warnings`
- `cargo clippy --features cli,wasm_runner -- -D warnings`
- `cargo clippy --no-default-features --features cli,llvm,native -- -D warnings`

## Remaining review recommendations (not implemented here)
These were intentionally left for follow-up work because they are broader refactors or policy decisions:
- Eliminating nested `cargo build` usage from `build.rs` entirely (it now uses an `OUT_DIR`-scoped `--target-dir`, but still shells out to Cargo; removing that likely requires a bigger re-think of runtime packaging/linking).
- Repo hygiene decisions (vendored `node_modules/`, `vendor/` provenance/licensing/security posture).
- Further diagnostics UX refinements (e.g., richer spans/columns for native-object errors beyond line-only).

Notes:
- The `tests/llvm_comprehensive_tests.rs` suite is very large (thousands of tests) and can take a long time to run locally; it is now opt-in behind the `llvm_comprehensive_tests` feature.
