# Code Coverage Analysis Report (mdhavers)
**Date:** 2025-12-18  
**Repo:** `mdhavers`  
**Tooling:** `cargo llvm-cov` (LLVM source-based coverage)  

## 1) Scope + reproduction

### Canonical command (used for the percentages below)
- `cargo llvm-cov --tests --summary-only`

This is treated as the “source of truth” because it is derived from `llvm-cov report` and matches per-file totals.

### Supporting artifacts generated during this review
- Missing-lines exports:
  - Baseline: `/tmp/mdhavers_missing_lines_round10.txt`
  - Current: `/tmp/mdhavers_missing_lines_round12.txt`

**Important:** the tool consistently reports `warning: 6 functions have mismatched data`. This can cause LCOV-derived totals to disagree with `llvm-cov report`. All percentages and “missed line” numbers in this report are based on the `llvm-cov report` view (`--summary-only` / `report --show-missing-lines`), not on LCOV.

## 2) Executive summary (current)

From `cargo llvm-cov --tests --summary-only` (**2025-12-18**, current):
- **TOTAL lines:** 40,073
- **TOTAL missed lines:** 801
- **TOTAL line coverage:** **98.00%**

Target: **98.00% line coverage**  
At 40,073 total lines, allowable missed lines are `floor(40,073 * 0.02) = 801`.  
So the target is **met** at **801 missed lines**.

**Progress during this work:** improved from 97.87% (853 missed / 39,989 total) to 98.00% (801 missed / 40,073 total).

## 3) Coverage by file (line coverage)

The following table is taken directly from the `cargo llvm-cov --tests --summary-only` output:

| File | Lines | Missed | Line cover |
|---|---:|---:|---:|
| `src/llvm/codegen.rs` | 22,085 | 299 | 98.65% |
| `src/interpreter.rs` | 9,252 | 270 | 97.08% |
| `src/parser.rs` | 1,601 | 11 | 99.31% |
| `src/compiler.rs` | 1,108 | 54 | 95.13% |
| `src/main.rs` | 683 | 42 | 93.85% |
| `src/wasm_compiler.rs` | 618 | 38 | 93.85% |
| `src/formatter.rs` | 855 | 25 | 97.08% |
| `src/ast.rs` | 605 | 19 | 96.86% |
| `src/llvm/compiler.rs` | 233 | 13 | 94.42% |
| `src/lsp/main.rs` | 238 | 13 | 94.54% |
| `src/value.rs` | 759 | 9 | 98.81% |
| `src/lsp/mdhavers_bindings.rs` | 575 | 7 | 98.78% |
| `src/error.rs` | 695 | 1 | 99.86% |
| `src/lexer.rs` | 124 | 0 | 100.00% |
| `src/lib.rs` | 140 | 0 | 100.00% |
| `src/token.rs` | 215 | 0 | 100.00% |
| `src/llvm/builtins.rs` | 43 | 0 | 100.00% |
| `src/llvm/runtime.rs` | 203 | 0 | 100.00% |
| `src/llvm/types.rs` | 37 | 0 | 100.00% |

**Key observation:** the two largest files (`src/llvm/codegen.rs`, `src/interpreter.rs`) still dominate missed lines. However, the final push to 98% came from closing deterministic parser/test gaps rather than trying to brute-force execution through large subsystems.

## 4) What the “Uncovered Lines” list does (and doesn’t) mean

`cargo llvm-cov report --show-missing-lines` ends with an “Uncovered Lines:” section. This list is **0-hit lines** only.

Two implications:
1. A file can have non-trivial “Missed Lines” but **not appear** in “Uncovered Lines” if its misses are mostly *partial/region-driven* (common with `match` guards, early `return Err(...)` lines, and multi-branch formatting code). In this baseline, **`src/compiler.rs`** is a notable example.
2. For fast progress, focusing on files that *do* have many 0-hit lines is usually the highest ROI.

## 5) Hotspot notes (current)

### A) `src/parser.rs` (11 missed lines; mostly partial)
The remaining misses are now mostly *partial/region-driven* lines rather than large blocks of 0-hit logic. Most of the high-leverage 0-hit branches were driven via unit tests (parse errors, slice edge cases, f-string edge handling, and escape parsing).

### B) `src/compiler.rs` (54 missed lines; not in “Uncovered Lines”)
This file’s misses are primarily *partial/region* misses rather than pure 0-hit lines. In practice, that often means:
- the “happy path” is covered, but specific branches of `match`/guards aren’t,
- or error-mapping lines execute but some internal branch remains unhit.

The quickest way to improve compiler coverage is usually to add tests that drive specific compile-time errors (invalid AST shapes, invalid op combos, etc.) rather than broad “compile a program” tests.

### C) `src/interpreter.rs` + `src/llvm/codegen.rs` (largest missed-line contributors)
These are still long-term improvement targets, but **they are not required** to hit 98% from this baseline:
- Interpreter misses are often error-path heavy (wrong-arity, not-callable, module-load failures).
- LLVM codegen misses can be very scattered; compile-only tests are effective, but can take longer to author.

## 6) What was implemented to reach 98%

High-level changes that materially moved line coverage:
1. Added targeted parser tests for 0-hit error/edge paths and f-string/escape corner cases.
2. Removed/avoided coverage-hostile “unreachable panic” patterns in tests.
3. Simplified a provably unreachable hex-parse error branch in `process_escapes` (while keeping correct behavior for incomplete/invalid hex sequences).

## 7) Appendix

- Baseline missing-lines export: `/tmp/mdhavers_missing_lines_round10.txt`
- Current missing-lines export: `/tmp/mdhavers_missing_lines_round12.txt`
