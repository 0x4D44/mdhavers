# Code Coverage Analysis Report (mdhavers)
**Date:** 2025-12-18  
**Repo:** `mdhavers`  
**Tooling:** `cargo-llvm-cov` (LLVM source-based coverage)  

## 1) Scope + reproduction

### Canonical command (used for the percentages below)
- `cargo llvm-cov --tests --summary-only`

This is treated as the “source of truth” because it is derived from `llvm-cov report` and matches the `--json` export’s per-file `summary.lines` counts.

### Supporting artifacts generated during this review
- JSON export: `cargo llvm-cov --tests --json --output-path /tmp/mdhavers_llvm_cov_2025_12_18.json`
- LCOV export: `cargo llvm-cov --tests --lcov --output-path /tmp/mdhavers_llvm_cov_2025_12_18.lcov`

**Important:** the tool consistently reports `warning: 6 functions have mismatched data`. This can cause **LCOV-derived** totals to disagree with `llvm-cov report` totals. All percentages and “missed line” numbers in this report are based on the `llvm-cov report` view (`--summary-only` / JSON `summary.lines`), not on LCOV.

## 2) Executive summary (current baseline)

From `cargo llvm-cov --tests --summary-only` (2025-12-18 run):
- **TOTAL lines:** 40,940
- **TOTAL missed lines:** 2,444
- **TOTAL line coverage:** **94.03%**

Target: **98% line coverage**  
At 40,940 total lines, the allowable missed lines are `floor(40,940 * 0.02) = 818`.  
So we must eliminate at least **2,444 - 818 = 1,626** missed lines (by covering lines, or removing/excluding truly untestable/dead lines from coverage builds).

## 3) Coverage by file (line coverage)

Top contributors to missed lines (from `llvm-cov report` table):
- `src/llvm/codegen.rs`: **94.19%**, **missed 1,334**
- `src/interpreter.rs`: **93.65%**, **missed 594**
- `src/main.rs`: **80.91%**, **missed 135**
- `src/lsp/main.rs`: **76.89%**, **missed 55**
- `src/lsp/mdhavers_bindings.rs`: **90.16%**, **missed 57**

Everything else combined accounts for ~269 missed lines (i.e., not enough to reach 98% without tackling `codegen.rs` + `interpreter.rs`).

## 4) High-value observations

### A) Misses are now concentrated in two files
To hit 98%, improvements must primarily come from:
- LLVM backend codegen coverage (`src/llvm/codegen.rs`)
- Interpreter coverage (`src/interpreter.rs`)

### B) Some misses are likely “structural”
Examples:
- TTY/raw-input builtins in the interpreter (`get_key`) are hard/impossible to exercise reliably under automated tests.
- Some LLVM codegen branches appear to be vestigial (e.g., builtin dispatch arms for tokens that are now parsed as keywords rather than callables). Those can be **dead code** and will never be covered by tests.

For these, the most honest path is to either:
- Refactor for testability (dependency injection / pure helpers), or
- Remove dead code, or
- Exclude truly untestable code from coverage builds via `#[cfg(not(coverage))]` (used sparingly, only when justified).

### C) `src/main.rs` / `src/lsp/main.rs` are not “0%” anymore
Both are now partially covered (CLI at ~81%, LSP at ~77%), indicating existing tests are exercising entrypoints, but not all subcommands / message paths.

## 5) Hotspot map (what to work on next)

### `src/llvm/codegen.rs`
- Remaining misses are fragmented across many small branches (often “else” cases and error mapping closures).
- Concrete unhit clusters identified from the JSON export include:
  - Default-argument fill logic in call compilation.
  - Top-level boxed-variable storage path.
  - Certain method dispatch fallbacks.
  - Several fast-path branches (string concat/int extraction) where the “no shadow” variants are unexercised.

### `src/interpreter.rs`
- Remaining misses include:
  - CLI-only raw-input code (`get_key`) and other OS/IO-adjacent paths.
  - A handful of edge/error branches in natives and execution/evaluation.

### `src/lsp/*`
- Coverage indicates the initialize/shutdown path is exercised, but other message-handling branches (hover/definition/formatting/diagnostics flow) remain uncovered.

