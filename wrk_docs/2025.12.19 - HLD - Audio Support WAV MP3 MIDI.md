# High-Level Design: Scots Audio Support (WAV, MP3, MIDI)

Date: 2025.12.19
Status: Proposed
Owner: mdhavers core

## 1. Summary
Add first-class audio support to mdhavers, independent of graphics, with a Scots-only API. Provide WAV and MP3 playback via raylib audio, and MIDI playback via a bundled SoundFont plus a MIDI synth pipeline. All English audio function names are removed.

## 2. Goals
- Audio works without graphics (no window required).
- Scots-only API names (no English aliases).
- Rich controls for playback, volume, pan, pitch, looping, and position.
- WAV + MP3 support.
- MIDI support with bundled SoundFont (plain file in repo).
- Target platforms: Windows and WSL.

## 3. Non-Goals
- Realtime MIDI input (devices).
- 3D/spatial audio.
- DSP effects (reverb, filters, etc.).
- Perfect sample-accurate seeking for MP3/MIDI (best effort only).
- Background audio thread (all updates are explicit via `soond_haud_gang`).

## 4. Constraints and Conventions
- Scots-only function names and error strings.
- Consistent verb set: `spiel`, `haud`, `gae_on`, `stap`, `loup`.
- Handle-based resource management (integer handles).
- No reliance on graphics window to initialize audio.

## 5. Feature Flags and Build Matrix
Add a new Cargo feature and keep it independent from `graphics`:
- `audio = ["raylib", "midly", "rustysynth"]`
- `graphics = ["raylib"]` (unchanged, does NOT imply audio)
- Default features remain `cli, llvm` (audio off by default).

Rationale: audio should be optional and independent; graphics should not pull MIDI deps or bundled SF2 by default.

## 6. Dependencies
- `raylib` crate: audio device, Sound, Music, AudioStream.
- `midly` crate: MIDI parsing.
- `rustysynth` crate: SoundFont synth (SF2).

(Exact versions chosen at implementation time; all must be permissive licenses.)

## 7. Bundled SoundFont
- File path: `assets/soundfonts/MuseScore_General.sf2`
- License: MIT (MuseScore General SoundFont).
- Include attribution and license file alongside the asset.
- File is large (~208 MB). Repo will include it as a plain file.

### Licensing notes
- Keep `assets/soundfonts/README.md` with:
  - Source link.
  - MIT license text.
  - Attribution notice required by the license.
- Ensure packaging scripts include the SF2 and license file.

## 8. Public Scots API
No English aliases are registered. The following are canonical.

### 8.1 Global / Device
- `soond_stairt()`
  - Initialize audio device.
  - Idempotent.
- `soond_steek()`
  - Close audio device and unload all audio handles.
- `soond_wheesht(aye|nae)`
  - Mute or unmute master output.
- `soond_luid(v)`
  - Set master volume (0.0 to 1.0).
- `soond_hou_luid() -> float`
  - Get master volume.
- `soond_haud_gang()`
  - Update streaming sources (MP3 + MIDI). Must be called regularly.

### 8.2 SFX (short sounds)
- `soond_lade(path) -> int`
- `soond_spiel(handle)`
- `soond_haud(handle)`
- `soond_gae_on(handle)`
- `soond_stap(handle)`
- `soond_unlade(handle)`
- `soond_is_spielin(handle) -> aye|nae`
- `soond_pit_luid(handle, v)`
- `soond_pit_pan(handle, pan)`
- `soond_pit_tune(handle, pitch)`
- `soond_pit_rin_roond(handle, aye|nae)`

### 8.3 Music / Streams (MP3, long WAV)
- `muisic_lade(path) -> int`
- `muisic_spiel(handle)`
- `muisic_haud(handle)`
- `muisic_gae_on(handle)`
- `muisic_stap(handle)`
- `muisic_unlade(handle)`
- `muisic_is_spielin(handle) -> aye|nae`
- `muisic_loup(handle, seconds)`
- `muisic_hou_lang(handle) -> float`
- `muisic_whaur(handle) -> float`
- `muisic_pit_luid(handle, v)`
- `muisic_pit_pan(handle, pan)`
- `muisic_pit_tune(handle, pitch)`
- `muisic_pit_rin_roond(handle, aye|nae)`

### 8.4 MIDI
- `midi_lade(path, soundfont = naething) -> int`
- `midi_spiel(handle)`
- `midi_haud(handle)`
- `midi_gae_on(handle)`
- `midi_stap(handle)`
- `midi_unlade(handle)`
- `midi_is_spielin(handle) -> aye|nae`
- `midi_loup(handle, seconds)`
- `midi_hou_lang(handle) -> float`
- `midi_whaur(handle) -> float`
- `midi_pit_luid(handle, v)`
- `midi_pit_pan(handle, pan)`

Notes:
- `soundfont` parameter accepts a path or `naething` for default.
- Pan range: -1.0 (left) to 1.0 (right).
- Pitch is a multiplier (1.0 = normal).

## 9. Runtime Architecture

### 9.1 Module layout
- `src/audio.rs`
  - Feature `audio` implementation.
- `src/audio_stub.rs` (or `cfg(not(feature = "audio"))` in same module)
  - Registers Scots functions but returns clear errors.
- `src/graphics.rs`
  - Remove audio registrations entirely.
- `src/interpreter.rs`
  - Always call `audio::register_audio_functions(&globals)` (stub does nothing or errors when feature off).

### 9.2 Global state
Use thread-local state to match existing style in `src/graphics.rs`:

```
thread_local! {
  static AUDIO_STATE: RefCell<AudioState> = RefCell::new(AudioState::new());
}

struct AudioState {
  initialized: bool,
  master_volume: f32,
  muted: bool,
  sounds: Vec<Option<SoundHandle>>,
  music: Vec<Option<MusicHandle>>,
  midi: Vec<Option<MidiHandle>>,
}
```

Handles store metadata and the raylib types:
- `SoundHandle { sound: Sound, volume, pan, pitch, looping }`
- `MusicHandle { music: Music, volume, pan, pitch, looping }`
- `MidiHandle { stream: AudioStream, synth: Synthesizer, events, position, ... }`

### 9.3 Handle allocation
- Integer handles are indices into `Vec<Option<T>>`.
- Reuse free slots when unloading.
- Reject invalid handles with Scots errors.

### 9.4 Audio init/close
- `soond_stairt`:
  - Initialize raylib audio device if not already.
  - Idempotent.
- `soond_steek`:
  - Stop all playback, unload all handles, close device.

Lazy init policy:
- If `soond_lade`, `muisic_lade`, or `midi_lade` is called before `soond_stairt`, auto-init.
- `soond_stairt` remains available for explicit setup.

### 9.5 Update loop
- `soond_haud_gang` updates:
  - All `Music` streams via `UpdateMusicStream`.
  - All active MIDI audio streams via `UpdateAudioStream`.

If users do not call `soond_haud_gang` regularly, streaming playback will stall or glitch.

## 10. WAV + MP3 Path (raylib)
- WAV SFX: load as `Sound` and play immediately.
- MP3 and long WAV: load as `Music` stream.
- Use raylib functions:
  - `LoadSound`, `PlaySound`, `PauseSound`, `ResumeSound`, `StopSound`
  - `SetSoundVolume`, `SetSoundPan`, `SetSoundPitch`
  - `LoadMusicStream`, `PlayMusicStream`, `PauseMusicStream`, `ResumeMusicStream`, `StopMusicStream`
  - `UpdateMusicStream`, `SeekMusicStream`, `SetMusicVolume`, `SetMusicPan`, `SetMusicPitch`
  - `GetMusicTimeLength`, `GetMusicTimePlayed`

## 11. MIDI Pipeline

### 11.1 Parsing
- Parse MIDI via `midly::Smf`.
- Build a list of timestamped MIDI events in seconds.
- Track tempo changes (microseconds per quarter note).

### 11.2 Synthesis
- Load SoundFont from:
  - `assets/soundfonts/MuseScore_General.sf2` by default.
  - Optional path override.
- Create `rustysynth::Synthesizer` with sample rate (e.g., 44100).
- Render PCM frames into a buffer on each update tick.

### 11.3 Audio output
- Create raylib `AudioStream` (stereo, 32-bit float).
- On `soond_haud_gang`, write enough frames to keep stream fed.
- Respect `midi_pit_luid` and `midi_pit_pan` by mixing synth output.

### 11.4 Seeking / looping
- `midi_loup(seconds)`:
  - Reset synth state, reset event pointer, set time position, then advance events up to that time.
- `midi_pit_rin_roond(aye|nae)`:
  - If enabled and end reached, reset to start.

## 12. Error Model (Scots)
- Missing feature:
  - "Soond isnae available - build wi' --features audio"
- Not initialized (if auto-init disabled for a specific call):
  - "Soond device isnae stairtit"
- Invalid handle:
  - "Thon handle isnae guid"
- File errors:
  - "Cannae find the file"
  - "Cannae lade the soond"

Errors should be consistent across `soond_*`, `muisic_*`, and `midi_*`.

## 13. Platform Notes
- Windows: uses native audio backend via raylib.
- WSL: works via WSLg or PulseAudio; document that a working audio stack is required.

## 14. Testing Strategy
- Unit tests for handle allocation and bounds checking.
- API registration tests: verify Scots function names are present when `audio` is enabled.
- Negative tests when audio feature disabled (stub returns expected Scots error).
- Manual smoke test script (not in CI):
  - Load WAV, play, adjust volume/pan/pitch.
  - Load MP3, play with `soond_haud_gang` in a loop.
  - Load MIDI with default SoundFont and verify playback.

## 15. Documentation Updates
- README: add audio section with Scots API examples and feature flag instructions.
- Add `docs/audio.md` with:
  - API reference.
  - Examples (SFX, MP3 stream, MIDI).
  - Note about `soond_haud_gang`.
- Mention SoundFont license and size.

## 16. Migration Plan
- Remove existing English audio names and stubs.
- Introduce Scots-only API with clear errors.
- Provide release notes:
  - "audio_* / sound_* / music_* removed; use Scots names."

## 17. Implementation Plan (Phased)
1. Create `src/audio.rs` and move audio registration out of `src/graphics.rs`.
2. Add `audio` feature and dependencies.
3. Implement SFX + music via raylib.
4. Add MIDI pipeline with `midly` + `rustysynth`.
5. Add SoundFont asset and license docs.
6. Update README and docs.
7. Add tests and manual smoke script.

## 18. Open Questions
- Exact sample rate and stream buffer sizing for MIDI.
- Whether to auto-init the audio device or require explicit `soond_stairt`.
- Whether to allow `soond_pit_rin_roond` for music and MIDI (recommended yes).

