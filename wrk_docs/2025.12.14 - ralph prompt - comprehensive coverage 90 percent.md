# Ralph Wiggum Prompt: Comprehensive Test Coverage to 90%+

## Core Philosophy

**The 90% coverage target is a PROXY for what we really want: working implementations.**

Currently there are **800+ ignored tests**. These tests are ignored because the underlying LLVM functions are broken, incomplete, or produce incorrect results. Simply adding more tests that pass won't help - we need to:

1. **FIX broken LLVM implementations** that cause tests to fail
2. **REMOVE ignore annotations** once the underlying code works
3. **ADD tests** for features that work but aren't tested

Coverage percentage is a symptom, not the disease. High coverage with 800 ignored tests is meaningless.

## Current State

| Metric | Current | Target |
|--------|---------|--------|
| codegen.rs coverage | 81.23% | 90%+ |
| parser.rs coverage | 85.37% | 90%+ |
| Tests passing | ~5,900 | - |
| Tests ignored | ~820 | **< 100** |

**Key insight**: Many ignored tests represent features that SHOULD work but don't. Fixing these provides more value than adding new passing tests.

## Priority Order

### Priority 1: Fix Broken LLVM Functions (HIGH IMPACT)

Look for tests with `#[ignore = "..."]` annotations. Common broken areas include:

1. **Spread operator** - crashes in LLVM codegen
2. **Slice with step** - `list[::2]` crashes
3. **Closures with captures** - captured variables return nil
4. **flatten/zip/find** - placeholder implementations that return wrong values
5. **Negative index assignment** - `list[-1] = x` doesn't work
6. **dict_has/has_key** - placeholder that always returns false

For each broken function:
1. Find the implementation in `src/llvm/codegen.rs`
2. Identify why it fails (crash, wrong output, unimplemented)
3. Fix the implementation
4. Remove the `#[ignore]` annotation from affected tests
5. Verify tests pass

### Priority 2: Fix Placeholder Implementations

Many "builtins" in codegen.rs are placeholders that return nil or wrong values:
```rust
// Example placeholder pattern in codegen.rs:
"some_function" => {
    / some_function(arg) - description (placeholder: return nil)
    ...
    return self.nil_value();  // <-- This is the problem
}
```

Search for `placeholder` comments in codegen.rs and implement properly.

### Priority 3: Add Tests for Untested Working Features

Only after fixing broken implementations, add tests for:
- Features that work but have no tests
- Edge cases of working features
- Error handling paths

## Workflow

### Step 1: Identify ignored tests
```bash
grep -c "#\[ignore" tests/llvm_comprehensive_tests.rs
# Shows count of ignored tests

grep -B2 "#\[ignore" tests/llvm_comprehensive_tests.rs | head -100
# Shows which tests are ignored and why
```

### Step 2: Pick a broken feature to fix
Choose based on:
- Number of tests it would un-ignore
- Importance of the feature
- Estimated complexity of fix

### Step 3: Fix the LLVM implementation
```bash
# Find the implementation
grep -n "broken_function_name" src/llvm/codegen.rs

# Read the code, understand why it fails, fix it
```

### Step 4: Test the fix
```bash
# Remove #[ignore] from affected tests, then run:
cargo test --features llvm --test llvm_comprehensive_tests "test_name"
```

### Step 5: Check coverage improvement
```bash
cargo llvm-cov --features llvm --test llvm_comprehensive_tests 2>&1 | tail -30
```

## Known Broken Features to Fix

### Spread Operator (HIGH PRIORITY)
Location: `codegen.rs:11462-11663`
Symptoms: Crashes during LLVM compilation
Tests affected: ~20 tests
```braw
# These should work but crash:
ken a = [1, 2, 3]
ken b = [0, ...a, 4]  # Spread in list
```

### Slice with Step
Location: `codegen.rs:20514-21103`
Symptoms: Crashes or returns wrong value
Tests affected: ~15 tests
```braw
# These should work:
ken list = [0, 1, 2, 3, 4, 5]
blether list[::2]   # Every other element
blether list[1:5:2] # Step of 2
```

### Closures with Captured Variables
Location: closure handling in codegen.rs
Symptoms: Returns nil instead of captured value
Tests affected: ~10 tests
```braw
# This should work:
ken x = 10
ken f = || x + 1
blether f()  # Should print 11, prints nil
```

### List Functions: flatten, zip, find, find_index, drap
Location: Various builtin handlers
Symptoms: Return nil or wrong values (placeholder implementations)
Tests affected: ~30 tests

### Dict Functions: has_key/dict_has
Location: dict builtin handlers
Symptoms: Always returns false
Tests affected: ~5 tests

## Success Criteria

The task is complete when:
1. **< 100 ignored tests** (down from 820)
2. **codegen.rs at 90%+ coverage**
3. **parser.rs at 90%+ coverage**
4. **All un-ignored tests pass**

## Reference: Scottish Dialect Keywords

| Scottish | English | Usage |
|----------|---------|-------|
| blether | print | `blether "hello"` |
| ken | let | `ken x = 5` |
| gin | if | `gin x > 0 { }` |
| ither | else | `gin x > 0 { } ither { }` |
| gie | return | `gie x + 1` |
| dae | function | `dae add(a, b) { gie a + b }` |
| kin | class | `kin Point { }` |
| masel | self | `masel.x = 10` |
| aye | true | `ken b = aye` |
| nae | false | `ken b = nae` |
| whiles | while | `whiles x < 10 { }` |
| fer | for | `fer i in range(0, 10) { }` |
| keek/whan | match | `keek x { whan 1 -> { } }` |
| hae_a_bash | try | `hae_a_bash { } gin_it_gangs_wrang e { }` |
| gin_it_gangs_wrang | catch | (see above) |
| brak | break | `brak` |
| haud | continue | `haud` |
| shove | push | `shove(list, item)` |
| yank | pop | `yank(list)` |
| ilk | map | `ilk(list, \|x\| x * 2)` |
| sieve | filter | `sieve(list, \|x\| x > 0)` |
| tumble | reduce | `tumble(list, 0, \|a, x\| a + x)` |

## Hints

- **Focus on fixing, not adding**: One fixed LLVM function can un-ignore 20+ tests
- **Placeholder pattern**: Search for `placeholder` in codegen.rs to find stubs
- **Crash debugging**: If a test crashes, check if it's a known pattern (spread, slice with step)
- **Type tag issues**: Many bugs come from wrong type tags on MdhValue structs
- **Memory issues**: Some bugs are from incorrect pointer handling in list/dict operations

## Test Commands

```bash
# Run all tests
cargo test --features llvm --test llvm_comprehensive_tests

# Run specific test
cargo test --features llvm --test llvm_comprehensive_tests test_name

# Run tests matching pattern
cargo test --features llvm --test llvm_comprehensive_tests "spread"

# Show ignored test count
cargo test --features llvm --test llvm_comprehensive_tests 2>&1 | grep "ignored"

# Full coverage report
cargo llvm-cov --features llvm --test llvm_comprehensive_tests
```
