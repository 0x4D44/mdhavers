# High-Level Design: Raw Terminal Input for LLVM Backend (Rev 2)

**Date:** 2025.12.09
**Author:** Gemini Agent
**Status:** Implementation in Progress

## 1. Objective

Enable "raw" terminal input support for `mdhavers` programs compiled via the LLVM backend. This allows compiled binaries to capture individual keystrokes immediately without waiting for a newline, enabling TUI applications and games.

## 2. Architecture: Hybrid Runtime Linking

Initially, the LLVM backend aimed for "full inlining" to avoid external runtime dependencies beyond `libc`. However, complex features like raw terminal I/O (requiring `termios` struct manipulation and ioctl calls) are excessively difficult to implement purely in LLVM IR.

Therefore, we adopt a **Hybrid Approach**:
*   **Simple Logic:** Inlined (arithmetic, logic, simple memory ops).
*   **Complex I/O:** Delegated to a C runtime library (`mdh_runtime.c`).

### 2.1. Compilation Pipeline

1.  **Parse & Codegen:** `mdhavers build file.braw` generates `file.o` using `CodeGen`.
2.  **Runtime Support:** `CodeGen` emits external calls (e.g., `call @__mdh_get_key`).
3.  **Linking:** The `LLVMCompiler` invokes the system linker (`cc`):
    ```bash
    cc file.o runtime/mdh_runtime.o -lm -lgc -o file
    ```

**Dependencies:**
*   `libgc` (Boehm GC): Required by `mdh_runtime.c` for memory management.
*   `libc` / `libm`: Standard C libraries.

## 3. Implementation Details

### 3.1. C Runtime (`runtime/mdh_runtime.c`)

*   **Function:** `MdhValue __mdh_get_key(void)`
*   **Logic:**
    *   Uses `<termios.h>` to disable `ICANON` and `ECHO` flags.
    *   Reads a single byte.
    *   Attempts to parse basic ANSI escape sequences (arrows) to return friendly strings: "Up", "Down", "Left", "Right".
    *   Restores terminal settings immediately.

### 3.2. LLVM Compiler (`src/llvm/compiler.rs`)

*   **Linker Args:** Must be updated to include `runtime/mdh_runtime.o` and `-lgc`.
*   **Path Resolution:** Currently assumes `runtime/mdh_runtime.o` exists relative to CWD. Future work should resolve this relative to the `mdhavers` executable.

### 3.3. LLVM Codegen (`src/llvm/codegen.rs`)

*   **Symbol Declaration:** Declares `__mdh_get_key` as an external function.
*   **Call Handling:** Intercepts `get_key()` calls in `compile_expr` and emits the call to the runtime symbol.

## 4. Verification

*   **Interpreter:** Verify `get_key` works using `crossterm` (already done).
*   **Compiler:** Verify `mdhavers build` produces a binary that links and runs.
    *   *Constraint:* Requires `libgc-dev` installed on the host system.

## 5. Future Improvements

*   **Windows Support:** Implement Windows specific console API in `mdh_runtime.c` (guarded by `#ifdef _WIN32`).
*   **Full Escape Parsing:** Improve C runtime to handle more keys (Home, End, F-keys).
*   **Runtime Distribution:** Package the compiled `mdh_runtime.o` or `.a` with the `mdhavers` release so users don't need the source code to compile.