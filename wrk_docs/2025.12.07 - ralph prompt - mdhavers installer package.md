# mdhavers Installer Package - Detailed Implementation Prompt

## Goal
Create a complete installer system for mdhavers that provides a Rust-like installation experience. Users should be able to install mdhavers with a single command and have it immediately available system-wide.

## Success Criteria
1. `curl -sSf https://raw.githubusercontent.com/.../install.sh | sh` style installation works
2. After installation, `mdhavers --version` works from any directory
3. Shell completions are installed and working
4. Uninstall command removes all installed files
5. `mdhavers self update` can update to latest version (optional, stretch goal)

## Directory Structure to Create

```
installer/
├── install.sh              # Main installation script (curl-able)
├── uninstall.sh            # Uninstallation script
├── completions/
│   ├── mdhavers.bash       # Bash completions
│   ├── mdhavers.zsh        # Zsh completions
│   └── mdhavers.fish       # Fish completions
├── scripts/
│   └── env.sh              # Environment setup script (sourced by shell rc)
└── README.md               # Installation documentation
```

## Installation Script Requirements (install.sh)

### Platform Detection
- Detect OS: Linux, macOS, Windows (WSL)
- Detect architecture: x86_64, aarch64/arm64
- Check for required dependencies (LLVM if native compilation wanted)

### Installation Steps
1. Create installation directory: `~/.mdhavers/`
2. Download or build mdhavers binary to `~/.mdhavers/bin/mdhavers`
3. Install LSP binary to `~/.mdhavers/bin/mdhavers-lsp`
4. Copy standard library to `~/.mdhavers/lib/` (if applicable)
5. Install shell completions to appropriate locations
6. Add `~/.mdhavers/bin` to PATH via shell rc file modification
7. Create `~/.mdhavers/env` script for manual sourcing

### Shell RC Modifications
The installer should add to `.bashrc`, `.zshrc`, or `config.fish`:
```bash
# mdhavers
. "$HOME/.mdhavers/env"
```

### env Script Content
```bash
#!/bin/sh
export MDHAVERS_HOME="$HOME/.mdhavers"
export PATH="$MDHAVERS_HOME/bin:$PATH"
```

### User Prompts
- Confirm installation location
- Ask about LLVM feature (if dependencies available)
- Offer to modify shell configuration
- Show post-installation instructions

## Shell Completions

### Bash Completions (mdhavers.bash)
Generate completions for:
- `mdhavers run <file>` - complete .braw files
- `mdhavers build <file>` - complete .braw files
- `mdhavers repl` - no completions needed
- `mdhavers fmt <file>` - complete .braw files
- `mdhavers check <file>` - complete .braw files
- Common flags: `--help`, `--version`, `-o`, `--opt-level`

### Zsh Completions (mdhavers.zsh)
Same as bash but using zsh completion syntax with descriptions.

### Fish Completions (mdhavers.fish)
Same commands using fish completion syntax.

## Uninstall Script Requirements (uninstall.sh)

1. Remove `~/.mdhavers/` directory
2. Remove mdhavers lines from shell rc files
3. Prompt for confirmation before proceeding
4. Show what will be removed before removing

## Build/Release Integration

### Makefile Targets
Add to existing Makefile:
```makefile
install: release
	./installer/install.sh --local

package: release
	# Create distributable tarball

dist-linux-x86_64:
	# Cross-compile for Linux x86_64

dist-macos-x86_64:
	# Cross-compile for macOS x86_64
```

### GitHub Release Assets
When releasing, include:
- `mdhavers-linux-x86_64.tar.gz`
- `mdhavers-linux-aarch64.tar.gz`
- `mdhavers-macos-x86_64.tar.gz`
- `mdhavers-macos-aarch64.tar.gz`
- `install.sh` (standalone installer)

## Testing Requirements

### Test Script (test_installer.sh)
1. Test fresh installation in clean environment
2. Verify PATH is correct after sourcing rc
3. Verify `mdhavers --version` works
4. Verify `mdhavers run` with simple script works
5. Test uninstallation removes all files
6. Test reinstallation over existing installation

### Docker Test Environment
Create Dockerfile for testing installation on clean systems:
- Ubuntu 22.04
- Debian 12
- Fedora 39
- Alpine Linux

## Implementation Order

1. **Phase 1: Basic Installer**
   - Create install.sh with local binary installation
   - Create env script
   - Modify shell rc files
   - Create uninstall.sh

2. **Phase 2: Shell Completions**
   - Generate bash completions using clap
   - Create zsh completions
   - Create fish completions
   - Install completions in correct locations

3. **Phase 3: Distribution**
   - Create Makefile targets for packaging
   - Create release tarballs
   - Set up GitHub release workflow (optional)

4. **Phase 4: Testing**
   - Create test script
   - Create Docker test environments
   - Test on multiple shells (bash, zsh, fish)

## Files to Create/Modify

### New Files
- `installer/install.sh`
- `installer/uninstall.sh`
- `installer/scripts/env.sh`
- `installer/completions/mdhavers.bash`
- `installer/completions/mdhavers.zsh`
- `installer/completions/mdhavers.fish`
- `installer/README.md`
- `installer/test_installer.sh`

### Modified Files
- `Makefile` - add install/package targets
- `src/main.rs` - add completion generation if using clap's derive feature
- `README.md` - add installation section

## Example Usage After Installation

```bash
# Install mdhavers
curl -sSf https://example.com/install.sh | sh

# Restart shell or source env
source ~/.mdhavers/env

# Verify installation
mdhavers --version
# => mdhavers 0.1.0

# Run a program
mdhavers run hello.braw

# Compile to native executable
mdhavers build hello.braw -o hello

# Start REPL
mdhavers repl

# Uninstall
~/.mdhavers/bin/mdhavers-uninstall
# or
curl -sSf https://example.com/uninstall.sh | sh
```

## Notes

- The installer should work without requiring root/sudo
- All files go under ~/.mdhavers to keep things contained
- The installer should be idempotent (safe to run multiple times)
- Provide clear error messages if dependencies are missing
- Support both interactive and non-interactive (--yes flag) modes
