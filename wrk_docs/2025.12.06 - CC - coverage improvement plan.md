# mdhavers Code Coverage Improvement Plan

**Date:** 2025-12-06  
**Target:** 98% coverage on core library modules  
**Starting Coverage:** 39.44%

## Multi-Stage Implementation Plan

### Stage 1: Quick Wins (Expected: 45-50% coverage)

**Estimated Time:** 1 hour  
**Focus:** Low-hanging fruit with high line counts

#### 1.1 token.rs Display Tests
Add tests to cover all 76 `TokenKind` display arms:
```rust
#[test]
fn test_token_kind_display() {
    // Test all token displays
    assert_eq!(format!("{}", TokenKind::Ken), "ken");
    // ... all tokens
}
```

#### 1.2 lib.rs Public API Tests
```rust
#[test]
fn test_run() { /* test run() function */ }
#[test]
fn test_run_with_output() { /* test run_with_output() */ }
#[test]
fn test_compile_to_js() { /* test JS compilation */ }
#[test]
fn test_compile_to_wat() { /* test WASM compilation */ }
#[test]
fn test_format_source() { /* test formatter */ }
```

#### 1.3 ast.rs Display Tests
Test Display implementations for Literal, BinaryOp, UnaryOp, LogicalOp, and span() methods.

---

### Stage 2: Error & Value Coverage (Expected: 55-65% coverage)

**Estimated Time:** 2 hours  
**Focus:** error.rs, value.rs comprehensive testing

#### 2.1 error.rs Tests
- Test `line()` method for all error variants
- Test `get_error_suggestion()` for all keyword misspellings
- Test `format_error_context()` edge cases
- Test random phrase functions

#### 2.2 value.rs Tests
- Test `Display` for all value types
- Test `type_name()` for all types
- Test arithmetic edge cases
- Test comparison operations
- Test collection operations

---

### Stage 3: Formatter Coverage (Expected: 70-75% coverage)

**Estimated Time:** 2 hours  
**Focus:** formatter.rs comprehensive testing

#### 3.1 Statement Formatting Tests
- Class declaration formatting
- Match statement formatting
- Try-catch formatting
- Destructuring formatting
- All control flow formatting

#### 3.2 Expression Formatting Tests
- F-string formatting
- Lambda formatting
- Pipe operator formatting
- Ternary expression formatting
- Complex nested expressions

---

### Stage 4: Compiler Coverage (Expected: 80-85% coverage)

**Estimated Time:** 3 hours  
**Focus:** compiler.rs, wasm_compiler.rs

#### 4.1 JS Compiler Tests
- Class compilation
- Match statement compilation
- Try-catch compilation
- All expression types
- Error handling paths

#### 4.2 WASM Compiler Tests
- Complete AST node coverage
- Error path testing

---

### Stage 5: Interpreter Deep Coverage (Expected: 90-95% coverage)

**Estimated Time:** 4 hours  
**Focus:** interpreter.rs systematic testing

#### 5.1 Built-in Function Edge Cases
Test every built-in function with:
- Normal cases (already covered)
- Edge cases (empty lists, nil values, type mismatches)
- Error conditions

#### 5.2 Error Path Testing
Force each error type to be triggered and verify correct error handling.

#### 5.3 Feature Interaction Testing
- Class inheritance scenarios
- Module import edge cases
- Pattern matching completeness
- Slice boundary conditions

---

### Stage 6: Parser & Final Polish (Expected: 98%+ coverage)

**Estimated Time:** 2 hours  
**Focus:** parser.rs gaps, final cleanup

#### 6.1 Parser Error Recovery
Test parser behavior with malformed input.

#### 6.2 Edge Case Hunting
Use coverage report to identify remaining uncovered lines and add targeted tests.

---

## Implementation Order

| Stage | Module(s) | Lines to Cover | Cumulative Target |
|-------|-----------|----------------|-------------------|
| 1 | token.rs, lib.rs, ast.rs | ~150 | 45% |
| 2 | error.rs, value.rs | ~200 | 60% |
| 3 | formatter.rs | ~170 | 72% |
| 4 | compiler.rs, wasm_compiler.rs | ~290 | 85% |
| 5 | interpreter.rs | ~2000 | 95% |
| 6 | parser.rs, cleanup | ~200 | 98% |

## Test File Structure

New test files to create:
- `tests/token_display_tests.rs`
- `tests/error_tests.rs`
- `tests/value_tests.rs`
- `tests/formatter_tests.rs`
- `tests/compiler_edge_tests.rs`
- `tests/wasm_edge_tests.rs`
- `tests/interpreter_edge_tests.rs`
- `tests/parser_edge_tests.rs`

Or add test modules within each source file.

## Success Criteria

1. Overall coverage ≥ 98% on core library modules
2. Each module individually ≥ 90% coverage
3. All public APIs have test coverage
4. All error paths have test coverage
5. Zero warnings from tarpaulin

## Verification Command

```bash
cargo tarpaulin --ignore-tests --exclude-files "src/main.rs" "src/lsp/main.rs" "src/llvm/*"
```
