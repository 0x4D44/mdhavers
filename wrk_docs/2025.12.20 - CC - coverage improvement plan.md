# Coverage Improvement Plan (Target: >=98% line coverage in src)
Date: 2025.12.20

## Stage 1: Stabilize baseline and unblock coverage runs
Goal: llvm-cov run succeeds consistently; build/fmt/clippy are clean.
- Fix failing import alias shadowing in LLVM backend. (done)
- Add/adjust tests for AST spans and LSP request/notification handling. (done)
- Ensure `cargo build --workspace`, `cargo fmt --all`, and `cargo clippy --workspace --all-targets` are clean. (done)

## Stage 2: Address lowest line-coverage files
Goal: Reduce uncovered branches in the most under-covered files.
- `src/main.rs`: add CLI tests for subcommand error paths, missing config, and argument parsing failures.
- `src/llvm/compiler.rs`: add tests for error paths and edge branches (bad target, invalid IR, filesystem failures).
- `src/wasm_compiler.rs`: add tests for unsupported constructs and error formatting paths.
- `src/lsp/main.rs`: expand tests for additional request/notification types and malformed inputs.
- `src/compiler.rs`: add tests for remaining error branches (two uncovered spots around compile-time errors).

## Stage 3: Broaden branch/region coverage
Goal: Improve region coverage and reduce uncovered conditional paths.
- Add tests that hit alternate branches in control-flow-heavy compiler/interpreter code.
- Add targeted tests for error hints and diagnostics (`src/error.rs`, `src/parser.rs`).
- Add focused tests for rarely used builtins or feature-specific branches.

## Stage 4: Feature-gated modules
Goal: Improve coverage in feature-conditional code without inflating default test time.
- Add audio-feature tests under `--features audio` for mix/playback edge paths.
- Add wasm/llvm backend tests for failure paths and option parsing.
- Ensure feature-gated tests are isolated and opt-in.

## Stage 5: Maintenance and guardrails
Goal: Keep coverage stable at or above target.
- Add a CI check: `cargo llvm-cov --workspace --no-default-features --features cli,llvm --fail-under-lines 98`.
- Document coverage commands and expectations in CONTRIBUTING or README.

## Current status
- Line coverage in `src/*` is already >=98% (98.18%). Further work would focus on the low-coverage hotspots listed in the report to raise coverage and reduce risk in CLI/LSP/backends.
