# 2025.12.23 - CR - Remediation Plan (mdhavers)

## Metadata
- Repo: `mdhavers` (`/home/md/language/mdhavers`)
- Date: 2025-12-23
- Git HEAD (uncommitted working tree): `e4226acbcb781d18e5fcbe97b333e4f72d3836e9`
- Source report: `wrk_docs/2025.12.23 - CR - Code Review Report.md`
- Tracking summary: `wrk_docs/2025.12.23 - CR - Remediation Summary.md`

## Goals
1) Reduce user-triggerable crashes/panics and state corruption in the interpreter.
2) Improve build portability (especially wasm32 and opt-in LLVM).
3) Reduce backend/tooling drift via parity tests and shared front-end logic.
4) Improve maintainability and developer ergonomics (tests, feature gating, tooling).

## Status legend
- âœ… done
- ğŸŸ¡ in progress
- â³ planned
- ğŸ’¤ deferred (needs a design decision / out-of-scope refactor)

## Remediations (prioritized)

### P0 â€” Correctness / crash safety
- âœ… Interpreter state restoration via RAII guards (`src/interpreter.rs`)
- âœ… Checked integer arithmetic + overflow errors; fixed int-vs-float comparisons (`src/interpreter.rs`)
- âœ… Module cache + circular import detection (`src/interpreter.rs`)

### P0 â€” Build portability / wasm
- âœ… Host/network/crypto moved behind `native` feature and wasm32 stubs added (`Cargo.toml`, `src/interpreter.rs`)
- âœ… Playground wasm build works: `cd playground && cargo build --target wasm32-unknown-unknown`

### P1 â€” Build system portability (LLVM backend)
- âœ… `build.rs` gated on `llvm`, uses `OUT_DIR` artifacts, rejects wasm32 targets (`build.rs`, `src/llvm/compiler.rs`)
- ğŸ’¤ Remove nested cargo invocation from `build.rs` (requires redesign of how `runtime/mdh_runtime_rs` is produced/embedded; left as a follow-up project)

### P1 â€” Tooling / editor correctness
- âœ… LSP diagnostics now use real lexer+parser (`src/lsp/mdhavers_bindings.rs`)
- âœ… VSCode extension selects a real existing LSP binary path (`editor/vscode/src/extension.ts`)

### P1 â€” Backend parity + runtime size
- âœ… JS compiler: emit `tri` runtime only when `tri` is imported (`src/compiler.rs`)
- âœ… Added interpreter-vs-JS parity smoke test (`tests/backend_parity.rs`)
- âœ… WASM compiler: reduce host import surface to only what the program uses (`src/wasm_compiler.rs`)

### P2 â€” Test/devex improvements
- âœ… Feature-aware CLI tests (`tests/cli_coverage.rs`)
- âœ… Replace hardcoded `target/debug/*` paths in tests with Cargo-provided binary paths (e.g. `CARGO_BIN_EXE_*`) (`tests/cli_coverage.rs`, `tests/lsp_coverage.rs`)
- âœ… Make LLVM-enabled clippy runs warning-clean (fix warnings in `runtime/mdh_runtime_rs`, and/or adjust build strategy)
- âœ… Gate the very large `tests/llvm_comprehensive_tests.rs` suite behind an opt-in feature (`llvm_comprehensive_tests`) to keep default developer runs fast
- âœ… Make minimal `--no-default-features --features cli` builds warning-clean under `-D warnings`

### P2 â€” Performance / maintainability
- âœ… Lexer performance + accurate position tracking for multiline tokens (`src/lexer.rs`)
- ğŸ’¤ WAT backend import ABI redesign (bigger change; may follow after usage-based import pruning)
- ğŸ’¤ Repo hygiene for vendored surfaces (`editor/vscode/node_modules/`, `vendor/`) requires policy decision

## Acceptance criteria (for planned items)
### Lexer perf/position
- No O(nÂ²) rescanning for column tracking on long lines.
- Correct `line`/`column` for multiline string literals and comments (as per language intent).
- `cargo test --lib --no-default-features --features cli` passes.

### WASM import surface minimization
- Generated WAT imports only what is needed by the compiled program (at minimum: avoid importing audio/network/tri helpers if unused).
- Existing wasm compiler tests updated appropriately (or extended to assert â€œimports included when usedâ€).

### Binary-path test robustness
- `tests/cli_coverage.rs` and `tests/lsp_coverage.rs` locate binaries using `CARGO_BIN_EXE_mdhavers` / `CARGO_BIN_EXE_mdhavers-lsp` (fallbacks only if needed).

### LLVM clippy hygiene
- `cargo clippy --no-default-features --features cli,llvm,native -- -D warnings` passes (or documented exception if intentionally not supported).

### LLVM comprehensive test suite (opt-in)
- Default LLVM test runs do not execute `tests/llvm_comprehensive_tests.rs` unless explicitly enabled.
- Full sweep command:
  - `cargo test --test llvm_comprehensive_tests --no-default-features --features cli,llvm,native,llvm_comprehensive_tests`
