# mdhavers — Code Coverage Review (LLVM source-based)

**Date:** 2025-12-24  
**Repo (HEAD):** `mdhavers` (`505be5ef4d811c52a8ef3957b4c47633f9b73434`)  
**Tooling:** `cargo-llvm-cov 0.6.20` (`rustc 1.91.0`, LLVM `21.1.2`)  

## Scope + definition of “coverage”

This review uses **LLVM source-based coverage** via `cargo-llvm-cov` and treats **Rust sources under `src/`** as the measured surface area for the selected feature set.

Important nuances:

- **Feature selection matters.** Code behind `#[cfg(feature = "...")]` is only measured when compiled with those features.
- **Integration tests (`tests/`) are not in the denominator**, but they *do* drive execution of code in `src/` (and therefore raise coverage).
- **Binaries (`src/main.rs`, `src/lsp/main.rs`) only gain coverage if executed**, typically via integration tests that spawn the instrumented binaries.
- **Coverage “percent” here is the `totals.lines.percent` from the JSON summary** produced by the canonical command below.

## Canonical command (scoreboard)

This effort uses this command as the single source-of-truth scoreboard:

```bash
cargo llvm-cov --no-default-features --features cli,llvm,native \
  --summary-only --json --output-path target/llvm-cov-summary.json
```

Supporting artifact for “what’s still cold” triage:

```bash
cargo llvm-cov --no-default-features --features cli,llvm,native \
  report --show-missing-lines > target/llvm-cov-missing-lines.txt
```

## Current results (target met)

From `target/llvm-cov-summary.json` (feature set: `cli,llvm,native`, `--no-default-features`):

- **Lines:** 55,930 / 56,747 = **98.56%** (missed: 817)
- **Functions:** 2,723 / 2,840 = **95.88%** (missed: 117)
- **Regions:** 98,573 / 103,488 = **95.25%** (missed: 4,915)
- **Instantiations:** 4,336 / 5,320 = **81.50%** (missed: 984)

✅ The requested **≥ 98% total line coverage** goal is satisfied under the canonical command.

## File-level line coverage hotspots (src-only)

From `target/llvm-cov-missing-lines.txt`, sorted by missed lines:

| File | Covered / Total | Missed | Coverage |
|---|---:|---:|---:|
| `src/interpreter.rs` | 12,603 / 13,183 | 580 | 95.60% |
| `src/llvm/codegen.rs` | 29,320 / 29,471 | 151 | 99.49% |
| `src/audio.rs` | 1,878 / 1,913 | 35 | 98.17% |
| `src/main.rs` | 811 / 816 | 5 | 99.39% |
| `src/value.rs` | 1,036 / 1,046 | 10 | 99.04% |
| `src/wasm_compiler.rs` | 1,147 / 1,157 | 10 | 99.14% |
| `src/llvm/compiler.rs` | 468 / 475 | 7 | 98.53% |
| `src/logging.rs` | 598 / 603 | 5 | 99.17% |
| `src/parser.rs` | 1,671 / 1,675 | 4 | 99.76% |
| `src/compiler.rs` | 1,430 / 1,433 | 3 | 99.79% |

## What the remaining misses generally are

This repository is already very strong on *line* coverage. The remaining misses are mostly:

- **Interpreter-only edges (`src/interpreter.rs`)**: validation paths, uncommon builtins, protocol/IO error surfaces, and “defensive” branches that require carefully constructed inputs.
- **LLVM codegen corner branches (`src/llvm/codegen.rs`)**: rare AST forms, alias/import metadata maintenance, and “should-never-happen” compile errors.
- **CLI UX branches (`src/main.rs`)**: REPL-specific error handling (e.g., Ctrl-C / unusual readline errors) and a few “empty state” paths.

Notably, **function and region coverage** remain materially lower than line coverage. That’s typical when:

- many helper functions are only used in narrow feature modes,
- rare error branches exist as separate functions/blocks,
- macros expand into multiple regions per line, and only some are exercised.

## Recommendation summary

If the only goal is to maintain the **≥98% line coverage gate**, current tests already satisfy it. If you want to push beyond that (or raise function/region coverage), the most cost-effective, low-flake approach is:

1) Add **deterministic, compilation-only** LLVM tests for cold codegen branches (cheap, stable).  
2) Add **deterministic interpreter tests** that hit validation/error paths without external network dependencies.  
3) Where branches are truly unreachable, prefer **invariant refactors** or reduce multi-line error constructions to avoid inflating missed-line counts.

See `wrk_docs/2025.12.24 - CC - Coverage Improvement Plan.md` for a staged plan.
