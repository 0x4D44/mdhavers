# fsm_demo.braw - Finite State Machine Demo
# "Keep track o' whit state yer in!"

fetch "../stdlib/fsm"

# Define colors locally to avoid import issues
dae yellow(text) { gie f"\x1b[33m{text}\x1b[0m" }
dae cyan(text) { gie f"\x1b[36m{text}\x1b[0m" }
dae green(text) { gie f"\x1b[32m{text}\x1b[0m" }
dae red(text) { gie f"\x1b[31m{text}\x1b[0m" }

blether ""
blether cyan("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
blether cyan("â•‘          FINITE STATE MACHINE DEMO                     â•‘")
blether cyan("â•‘         \"Keep track o' whit state yer in!\"             â•‘")
blether cyan("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether ""

# ============================================================
# Simple Toggle Example
# ============================================================

blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether yellow("  SIMPLE TOGGLE")
blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether ""

ken toggle = toggle_machine("Light Switch")
blether f"Initial state: {toggle.get_state()}"
toggle.trigger("toggle")
blether f"After toggle: {toggle.get_state()}"
toggle.trigger("toggle")
blether f"After toggle: {toggle.get_state()}"
toggle.trigger("toggle")
blether f"After toggle: {toggle.get_state()}"
blether ""

# ============================================================
# Traffic Light
# ============================================================

blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether yellow("  TRAFFIC LIGHT")
blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether ""

ken traffic = traffic_light_machine()
blether f"Initial: {traffic.get_state()}"
blether f"Available actions: {traffic.available_triggers()}"
traffic.trigger("go")
blether f"After 'go': {traffic.get_state()}"
traffic.trigger("slow")
blether f"After 'slow': {traffic.get_state()}"
traffic.trigger("stop")
blether f"After 'stop': {traffic.get_state()}"
blether ""

# ============================================================
# Door with Callbacks
# ============================================================

blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether yellow("  DOOR WITH CALLBACKS")
blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether ""

ken door = door_machine()

# Helper functions for callbacks
dae on_door_open() { blether "  ğŸšª The door swings open!" }
dae on_door_close() { blether "  ğŸšª The door shuts with a click." }
dae on_door_lock() { blether "  ğŸ”’ *CLICK* The door is now locked." }
dae on_door_unlock() { blether "  ğŸ”‘ *CLICK* Unlocking..." }

# Add enter callbacks
door.set_on_enter("open", on_door_open)
door.set_on_enter("closed", on_door_close)
door.set_on_enter("locked", on_door_lock)

# Add exit callbacks
door.set_on_exit("locked", on_door_unlock)

blether f"Door starts: {door.get_state()}"
door.trigger("open")
blether f"State: {door.get_state()}"
door.trigger("close")
blether f"State: {door.get_state()}"
door.trigger("lock")
blether f"State: {door.get_state()}"
door.trigger("unlock")
blether f"State: {door.get_state()}"
blether ""

# ============================================================
# Order Workflow
# ============================================================

blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether yellow("  ORDER WORKFLOW")
blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether ""

ken order = order_workflow_machine()
blether f"Order state: {order.get_state()}"
blether f"Is order complete? {order.is_done()}"
blether ""

blether "Processing order..."
order.trigger("confirm")
blether f"  Confirmed: {order.get_state()}"
order.trigger("ship")
blether f"  Shipped: {order.get_state()}"
order.trigger("deliver")
blether f"  Delivered: {order.get_state()}"
blether f"Is order complete? {order.is_done()}"
blether ""

blether "Order history:"
fer h in order.get_history() {
    blether f"  {h[\"from\"]} --[{h[\"trigger\"]}]--> {h[\"to\"]}"
}
blether ""

# ============================================================
# Character States (Game Example)
# ============================================================

blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether yellow("  GAME CHARACTER STATES")
blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether ""

ken player = character_state_machine()

# Set up transition logging
dae log_player_transition(from, event, to) {
    blether f"  Player: {from} --[{event}]--> {to}"
}
player.set_on_transition(log_player_transition)

blether "Simulating player actions..."
player.trigger("walk")
player.trigger("run")
player.trigger("jump")
player.trigger("land")
player.trigger("walk")
player.trigger("stop")
blether ""

blether f"Final state: {player.get_state()}"
blether ""

# ============================================================
# Custom State Machine
# ============================================================

blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether yellow("  CUSTOM STATE MACHINE")
blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether ""

ken vending = state_machine("Vending Machine")
vending.add_state("idle", aye, nae)
vending.add_state("has_money", nae, nae)
vending.add_state("dispensing", nae, nae)

vending.add_transition("idle", "insert_coin", "has_money")
vending.add_transition("has_money", "insert_coin", "has_money")
vending.add_transition("has_money", "select_item", "dispensing")
vending.add_transition("has_money", "cancel", "idle")
vending.add_transition("dispensing", "take_item", "idle")

vending.display()
blether ""

blether "Using the vending machine..."
blether f"State: {vending.get_state()}"
vending.trigger("insert_coin")
blether f"After insert_coin: {vending.get_state()}"
vending.trigger("insert_coin")
blether f"After insert_coin: {vending.get_state()}"
vending.trigger("select_item")
blether f"After select_item: {vending.get_state()}"
vending.trigger("take_item")
blether f"After take_item: {vending.get_state()}"
blether ""

# ============================================================
# Whisky Production (Scottish Theme!)
# ============================================================

blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether yellow("  ğŸ¥ƒ WHISKY PRODUCTION PROCESS")
blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether ""

ken whisky = whisky_production_machine()

# Whisky production stage callbacks
dae on_malting() { blether "  ğŸŒ¾ Soaking barley and letting it sprout..." }
dae on_mashing() { blether "  âš™ï¸  Grinding the malt and mixing wi' hot water..." }
dae on_fermenting() { blether "  ğŸ§ª Adding yeast - let the magic happen..." }
dae on_distilling() { blether "  ğŸ”¥ Heating in copper stills..." }
dae on_maturing() { blether "  ğŸªµ Aging in oak barrels fer years..." }
dae on_bottling() { blether "  ğŸ¾ Bottling the liquid gold!" }

whisky.set_on_enter("malting", on_malting)
whisky.set_on_enter("mashing", on_mashing)
whisky.set_on_enter("fermenting", on_fermenting)
whisky.set_on_enter("distilling", on_distilling)
whisky.set_on_enter("maturing", on_maturing)
whisky.set_on_enter("bottling", on_bottling)

blether f"Starting production: {whisky.get_state()}"
blether ""

whisky.trigger("grind")
whisky.trigger("add_yeast")
whisky.trigger("heat")
whisky.trigger("barrel")
whisky.trigger("bottle")

blether ""
blether f"Final state: {whisky.get_state()}"
blether f"Is the whisky ready? {whisky.is_done()}"
blether ""

# ============================================================
# Ceilidh Dance
# ============================================================

blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether yellow("  ğŸ’ƒ CEILIDH DANCE")
blether yellow("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether ""

ken dance = ceilidh_machine()

# Ceilidh dance callbacks
dae on_bow() { blether "  ğŸ© Bow to yer partner!" }
dae on_circle_left() { blether "  â†º  Circle tae the left!" }
dae on_circle_right() { blether "  â†»  Circle tae the right!" }
dae on_do_si_do() { blether "  ğŸ”„ Do-si-do!" }
dae on_promenade() { blether "  ğŸ‘« Promenade around the hall!" }
dae on_finish() { blether "  ğŸ‰ Bow and applause!" }

dance.set_on_enter("bow", on_bow)
dance.set_on_enter("circle_left", on_circle_left)
dance.set_on_enter("circle_right", on_circle_right)
dance.set_on_enter("do_si_do", on_do_si_do)
dance.set_on_enter("promenade", on_promenade)
dance.set_on_enter("finish", on_finish)

blether "The ceilidh begins..."
blether f"State: {dance.get_state()}"
blether ""

dance.trigger("start")
dance.trigger("next")
dance.trigger("next")
dance.trigger("next")
dance.trigger("next")
dance.trigger("end")

blether ""
blether f"Dance complete! Final state: {dance.get_state()}"
blether ""

blether green("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether green("  FSM demo complete!")
blether green("  \"Keep track o' yer states!\"")
blether green("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
blether ""
